<!doctype html>
<html lang="es">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <title>Sistema de Ventas</title>
    <style>
        /* ESTILOS GENERALES */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family:
                -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Oxygen-Sans,
                Ubuntu, Cantarell, sans-serif;
            background: #f8f9fa;
            color: #333;
            line-height: 1.6;
        }

        /* CONTAINER PRINCIPAL */
        .sistema-ventas-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        /* LOGIN */
        .login-container {
    min-height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
    background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
}

        .login-box {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 600px;
            /* M치s ancho */
        }

        .login-box h1 {
            color: #333;
            margin-bottom: 0.5rem;
            text-align: center;
        }

        .login-box h2 {
            color: #666;
            margin-bottom: 2rem;
            text-align: center;
            font-weight: 400;
        }

        /* FORMULARIOS */
        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }

        /* BOTONES */
        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 0.75rem 1.5rem;
            border-radius: 5px;
            font-size: 1rem;
            cursor: pointer;
            transition: background-color 0.3s;
            display: inline-block;
            text-decoration: none;
            text-align: center;
        }

        .btn:hover {
            background: #5a67d8;
        }

        .btn-small {
            padding: 0.25rem 0.75rem;
            font-size: 0.875rem;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-register {
            background: #28a745;
            margin-top: 1rem;
            width: 100%;
        }

        .btn-register:hover {
            background: #218838;
        }

        /* MENSAJES */
        .alert {
            padding: 1rem;
            border-radius: 5px;
            margin-bottom: 1rem;
            border-left: 4px solid;
        }

        .alert-error {
            background: #fee;
            color: #c33;
            border-left-color: #c33;
        }

        .alert-success {
            background: #efe;
            color: #2a7;
            border-left-color: #2a7;
        }

        .alert-info {
            background: #e3f2fd;
            color: #0366d6;
            border-left-color: #0366d6;
        }

        /* DASHBOARD LAYOUT */
        .dashboard-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 250px;
            background: #2c3e50;
            color: white;
            padding: 1rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
        }

        .user-info {
            text-align: center;
            padding: 1rem;
            border-bottom: 1px solid #34495e;
            margin-bottom: 1rem;
        }

        .profile-pic {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            object-fit: cover;
            margin: 0 auto 1rem;
            border: 3px solid #667eea;
            cursor: pointer;
        }

        .profile-pic-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #667eea;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            margin: 0 auto 1rem;
            cursor: pointer;
        }

        .sidebar nav ul {
            list-style: none;
        }

        .sidebar nav li {
            margin-bottom: 0.25rem;
        }

        .sidebar nav a {
            display: block;
            padding: 0.75rem 1rem;
            color: #bdc3c7;
            text-decoration: none;
            transition: all 0.3s;
            border-left: 3px solid transparent;
        }

        .sidebar nav a:hover,
        .sidebar nav a.active {
            background: #34495e;
            color: white;
            border-left-color: #667eea;
        }

        .main-content {
            flex: 1;
            background: #f8f9fa;
            margin-left: 250px;
        }

        header {
            background: white;
            padding: 1rem 2rem;
            border-bottom: 1px solid #dee2e6;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        header h1 {
            font-size: 1.5rem;
            color: #2c3e50;
        }

        .content {
            padding: 2rem;
        }

        /* TARJETAS */
        .card {
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .card h2 {
            color: #2c3e50;
            margin-bottom: 1.5rem;
            padding-bottom: 0.75rem;
            border-bottom: 2px solid #f0f0f0;
        }

        /* TABLAS */
        .data-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }

        .data-table th {
            background: #f8f9fa;
            padding: 0.75rem;
            text-align: left;
            font-weight: 600;
            color: #495057;
            border-bottom: 2px solid #dee2e6;
        }

        .data-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #dee2e6;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .table-responsive {
            overflow-x: auto;
        }

        /* GRIDS */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-card {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
            border-left: 4px solid #667eea;
        }

        .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 0.5rem 0;
        }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            width: 90%;
            max-width: 600px;
            /* M치s ancho */
            padding: 2rem;
            border-radius: 10px;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
        }

        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }

        /* SELECTOR DE ROL */
        .role-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 1rem;
        }

        .role-option {
            text-align: center;
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .role-option:hover {
            border-color: #667eea;
            background: #f8f9fa;
        }

        .role-option.selected {
            border-color: #667eea;
            background: #f0f4ff;
        }

        .role-icon {
            font-size: 24px;
            margin-bottom: 5px;
        }

        /* FORMULARIO HORIZONTAL */
        .form-horizontal {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1rem;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                position: relative;
                height: auto;
            }

            .main-content {
                margin-left: 0;
            }

            .dashboard-container {
                flex-direction: column;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .role-selector {
                grid-template-columns: 1fr;
            }

            .form-horizontal {
                grid-template-columns: 1fr;
            }

            header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }

            .login-box {
                max-width: 95%;
            }
        }

        /* LOADER */
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 2rem auto;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }

        /* BADGES */
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
        }

        .badge-success {
            background: #28a745;
            color: white;
        }

        .badge-warning {
            background: #ffc107;
            color: #212529;
        }

        .badge-info {
            background: #17a2b8;
            color: white;
        }

        /* PAGINATION */
        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 2rem;
        }

        .page-link {
            padding: 0.5rem 1rem;
            border: 1px solid #dee2e6;
            background: white;
            color: #667eea;
            text-decoration: none;
            border-radius: 5px;
        }

        .page-link:hover,
        .page-link.active {
            background: #667eea;
            color: white;
            border-color: #667eea;
        }
    </style>
</head>

<body>
    <div id="app" class="sistema-ventas-container">
        <!-- EL CONTENIDO SE CARGA DIN츼MICAMENTE AQU칈 -->
    </div>

    <script>
        // ==================== SISTEMA DE VENTAS COMPLETO ====================
        // TODOS LOS DATOS Y L칍GICA EN UN SOLO ARCHIVO
const firebaseConfig = {
  apiKey: "AIzaSyAlEGwpTS3Igy6f66fXDAUXcxjxiilfUfc",
  authDomain: "basedatsocuidadmovil.firebaseapp.com",
  projectId: "basedatsocuidadmovil",
  storageBucket: "basedatsocuidadmovil.firebasestorage.app",
  messagingSenderId: "190117042782",
  appId: "1:190117042782:web:bb25eacb113579478eb2cf",
  measurementId: "G-Q9L3WHWRVQ"
};

// Inicializar Firebase
let firebaseApp, db;

try {
    firebaseApp = firebase.initializeApp(firebaseConfig);
    db = firebase.firestore();
    console.log("Firebase inicializado correctamente");
} catch (error) {
    console.error("Error inicializando Firebase:", error);
}
        // Variables globales
        let presupuestosData = {};
let currentUser = null;
let currentView = "login";
let alertMessage = null;
let alertType = null;
let registroAlertMessage = null;
let registroAlertType = null;
let ventasData = [];
let clientesData = [];
let usuariosData = [];
let currentPage = 1;
const itemsPerPage = 10;
const SECURITY_KEY = "ciudadmovilcolombia2026";

        // Datos iniciales
        const datosIniciales = {
            usuarios: [
                {
                    id: 1,
                    username: "gerente",
                    password: "gerente123",
                    nombre: "Gerente Principal",
                    rol: "gerente",
                    sede: "Todas",
                    foto: "",
                },
                {
                    id: 2,
                    username: "Yolanda",
                    password: "Yolanda12345",
                    nombre: "Yolanda",
                    rol: "asesor",
                    sede: "Cra 33 Cabecera",
                    foto: "",
                },
                {
                    id: 3,
                    username: "Sandra",
                    password: "Sandra12345",
                    nombre: "Sandra",
                    rol: "asesor",
                    sede: "La Concordia",
                    foto: "",
                },
                {
                    id: 4,
                    username: "Lina",
                    password: "Lina12345",
                    nombre: "Lina",
                    rol: "asesor",
                    sede: "Giron",
                    foto: "",
                },
                {
                    id: 5,
                    username: "Fabiola",
                    password: "Fabiola12345",
                    nombre: "Fabiola",
                    rol: "asesor",
                    sede: "Cra 33 Cabecera",
                    foto: "",
                },
                {
                    id: 6,
                    username: "Adriana",
                    password: "Adriana12345",
                    nombre: "Adriana",
                    rol: "asesor",
                    sede: "Barrancabermeja",
                    foto: "",
                },
                {
                    id: 7,
                    username: "DinaLuz",
                    password: "Dina Luz12345",
                    nombre: "Dina Luz",
                    rol: "asesor",
                    sede: "Valledupar",
                    foto: "",
                },
                {
                    id: 8,
                    username: "cliente",
                    password: "cliente123",
                    nombre: "Cliente Externo",
                    rol: "cliente",
                    sede: "Externo",
                    foto: "",
                },
            ],

            ventas: [
                // Ventas de YOLANDA (Enero)
                {
                    id: 1,
                    asesor: "YOLANDA",
                    cliente: "TATIANA CRISTANCHO",
                    cedula: "1100960993",
                    celular: "3115747666",
                    tipo: "carro",
                    referencia: "XIAOMA",
                    agencia: "Cra 33 Cabecera",
                    fuente: "sala",
                    clasificacion: "decision",
                    tipoCliente: "no-moto",
                    mes: 1,
                    anio: 2025,
                },
                {
                    id: 2,
                    asesor: "YOLANDA",
                    cliente: "NELSON ESPINOSA",
                    cedula: "91255205",
                    celular: "3188067551",
                    tipo: "moto",
                    referencia: "REVOO C32",
                    agencia: "Cra 33 Cabecera",
                    fuente: "sala",
                    clasificacion: "decision",
                    tipoCliente: "no-moto",
                    mes: 1,
                    anio: 2025,
                },
                {
                    id: 3,
                    asesor: "YOLANDA",
                    cliente: "JAIRO ALBERTO QUINTERO",
                    cedula: "1051655034",
                    celular: "3135000422",
                    tipo: "patineta",
                    referencia: "E2 PLUS II",
                    agencia: "Cra 33 Cabecera",
                    fuente: "sala",
                    clasificacion: "decision",
                    tipoCliente: "no-moto",
                    mes: 1,
                    anio: 2025,
                },
                {
                    id: 4,
                    asesor: "YOLANDA",
                    cliente: "JULIETH TATIANA FOREZ",
                    cedula: "1098823914",
                    celular: "3209694175",
                    tipo: "moto",
                    referencia: "MINI BWS",
                    agencia: "Cra 33 Cabecera",
                    fuente: "sala",
                    clasificacion: "decision",
                    tipoCliente: "no-moto",
                    mes: 1,
                    anio: 2025,
                },
                {
                    id: 5,
                    asesor: "YOLANDA",
                    cliente: "NYLSON MU칌OZ",
                    cedula: "91073357",
                    celular: "3169298300",
                    tipo: "moto",
                    referencia: "OMEGA",
                    agencia: "Cra 33 Cabecera",
                    fuente: "sala",
                    clasificacion: "decision",
                    tipoCliente: "no-moto",
                    mes: 1,
                    anio: 2025,
                },

                // Ventas de FABIOLA
                {
                    id: 6,
                    asesor: "FABIOLA",
                    cliente: "LAURA",
                    cedula: "",
                    celular: "3153737995",
                    tipo: "moto",
                    referencia: "C32",
                    agencia: "Cra 33 Cabecera",
                    fuente: "sala",
                    clasificacion: "decision",
                    tipoCliente: "no-moto",
                    mes: 1,
                    anio: 2025,
                },
                {
                    id: 7,
                    asesor: "FABIOLA",
                    cliente: "LUZ ALEAN",
                    cedula: "",
                    celular: "3044385558",
                    tipo: "moto",
                    referencia: "AGUIL MAX",
                    agencia: "Cra 33 Cabecera",
                    fuente: "sala",
                    clasificacion: "decision",
                    tipoCliente: "no-moto",
                    mes: 1,
                    anio: 2025,
                },

                // Ventas de LINA
                {
                    id: 8,
                    asesor: "LINA",
                    cliente: "karen johana rodriguez",
                    cedula: "30210955",
                    celular: "3173754400",
                    tipo: "moto",
                    referencia: "AGUILAPRO",
                    agencia: "Giron",
                    fuente: "sala",
                    clasificacion: "decision",
                    tipoCliente: "no-moto",
                    mes: 1,
                    anio: 2025,
                },
                {
                    id: 9,
                    asesor: "LINA",
                    cliente: "EUGENIO FONSECA LIZARAZO",
                    cedula: "91508358",
                    celular: "3182720650",
                    tipo: "moto",
                    referencia: "ALFA",
                    agencia: "Giron",
                    fuente: "sala",
                    clasificacion: "decision",
                    tipoCliente: "no-moto",
                    mes: 1,
                    anio: 2025,
                },

                // Ventas de SANDRA
                {
                    id: 10,
                    asesor: "SANDRA",
                    cliente: "JANETH BAYONA",
                    cedula: "63441628",
                    celular: "3177604485",
                    tipo: "moto",
                    referencia: "AGUILA PRO",
                    agencia: "La Concordia",
                    fuente: "sala",
                    clasificacion: "decision",
                    tipoCliente: "no-moto",
                    mes: 1,
                    anio: 2025,
                },

                // Ventas de DINA LUZ
                {
                    id: 11,
                    asesor: "DINA LUZ",
                    cliente: "Aura Lizeth Pinto Bar칩n",
                    cedula: "1095823968",
                    celular: "3138254786",
                    tipo: "moto",
                    referencia: "AGUILA MAX",
                    agencia: "Valledupar",
                    fuente: "digital",
                    clasificacion: "decision",
                    tipoCliente: "no-moto",
                    mes: 1,
                    anio: 2025,
                },
            ],

            clientes: [
                // Clientes de YOLANDA
                {
                    id: 1,
                    asesor: "YOLANDA",
                    fecha: "05/01/2025",
                    nombre: "MARGARITA MOGICA",
                    cedula: "28147954",
                    celular: "3185298291",
                    email: "danielaparra0797@gmail.com",
                    tipoCliente: "cm",
                    fuente: "referido",
                    tipoVehiculo: "moto",
                    referencia: "FAMILY",
                    formaPago: "ESSA",
                    mes: 1,
                    anio: 2025,
                },
                {
                    id: 2,
                    asesor: "YOLANDA",
                    fecha: "05/01/2025",
                    nombre: "DANNA VALENTINA VILLAR",
                    cedula: "63306328",
                    celular: "3165074082",
                    email: "",
                    tipoCliente: "digital",
                    fuente: "digital",
                    tipoVehiculo: "moto",
                    referencia: "GIRL 4",
                    formaPago: "ESSA",
                    mes: 1,
                    anio: 2025,
                },
                {
                    id: 3,
                    asesor: "YOLANDA",
                    fecha: "06/01/2025",
                    nombre: "CARLOS SANCHEZ",
                    cedula: "",
                    celular: "3165759905",
                    email: "",
                    tipoCliente: "digital",
                    fuente: "digital",
                    tipoVehiculo: "moto",
                    referencia: "RAPTOR MAX",
                    formaPago: "DE CONTADO",
                    mes: 1,
                    anio: 2025,
                },

                // Clientes de FABIOLA
                {
                    id: 4,
                    asesor: "FABIOLA",
                    fecha: "05/01/2026",
                    nombre: "LAURA",
                    cedula: "",
                    celular: "3153737995",
                    email: "",
                    tipoCliente: "digital",
                    fuente: "digital",
                    tipoVehiculo: "moto",
                    referencia: "c32",
                    formaPago: "ESSA",
                    mes: 1,
                    anio: 2026,
                },

                // Clientes de LINA
                {
                    id: 5,
                    asesor: "LINA",
                    fecha: "05/01/2026",
                    nombre: "karen johana rodriguez",
                    cedula: "30210955",
                    celular: "3173754400",
                    email: "RODRIGUEZHERRERA20@GMAIL.COM",
                    tipoCliente: "digital",
                    fuente: "digital",
                    tipoVehiculo: "moto",
                    referencia: "aguilapro",
                    formaPago: "",
                    mes: 1,
                    anio: 2026,
                },

                // Clientes de SANDRA
                {
                    id: 6,
                    asesor: "SANDRA",
                    fecha: "05/01/2026",
                    nombre: "JANETH BAYONA",
                    cedula: "63441628",
                    celular: "3177604485",
                    email: "",
                    tipoCliente: "no-moto",
                    fuente: "sala",
                    tipoVehiculo: "moto",
                    referencia: "AGUILA PRO",
                    formaPago: "ESSA",
                    mes: 1,
                    anio: 2026,
                },

                // Clientes de DINA LUZ
                {
                    id: 7,
                    asesor: "DINA LUZ",
                    fecha: "05/01/2026",
                    nombre: "MALVI BOLA칌O",
                    cedula: "",
                    celular: "3205289954",
                    email: "",
                    tipoCliente: "no-moto",
                    fuente: "digital",
                    tipoVehiculo: "moto",
                    referencia: "FAMILY Q",
                    formaPago: "",
                    mes: 1,
                    anio: 2026,
                },
            ],
        };

        // Funciones de utilidad
        function showAlert(message, type = "error") {
            alertMessage = message;
            alertType = type;
            setTimeout(() => {
                alertMessage = null;
                alertType = null;
                render();
            }, 3000);
        }

        function showRegistroAlert(message, type = "error") {
            registroAlertMessage = message;
            registroAlertType = type;
            // Actualizar solo el modal de registro
            actualizarModalRegistro();
            setTimeout(() => {
                registroAlertMessage = null;
                registroAlertType = null;
                actualizarModalRegistro();
            }, 3000);
        }

        function actualizarModalRegistro() {
            const modal = document.getElementById("registroModal");
            if (modal && modal.style.display === "flex") {
                // Solo actualizar el contenido del alert dentro del modal
                const alertDiv = modal.querySelector("#registroAlert");
                if (alertDiv) {
                    if (registroAlertMessage) {
                        alertDiv.innerHTML = `<div class="alert alert-${registroAlertType}">${registroAlertMessage}</div>`;
                        alertDiv.style.display = "block";
                    } else {
                        alertDiv.innerHTML = "";
                        alertDiv.style.display = "none";
                    }
                }
            }
        }

        function getSedes() {
            return [
                "La Concordia",
                "Giron",
                "Cra 33 Cabecera",
                "Barrancabermeja",
                "Valledupar",
            ];
        }

        function getMeses() {
            return {
                1: "Enero",
                2: "Febrero",
                3: "Marzo",
                4: "Abril",
                5: "Mayo",
                6: "Junio",
                7: "Julio",
                8: "Agosto",
                9: "Septiembre",
                10: "Octubre",
                11: "Noviembre",
                12: "Diciembre",
            };
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString("es-ES");
        }

        // Inicializar datos desde localStorage o datos iniciales
async function initData() {
    // Cargar datos primero
    await loadDataFromFirebase();
    
    // Cargar usuario actual y vista actual desde localStorage
    const storedUser = localStorage.getItem("currentUser");
    const storedView = localStorage.getItem("currentView");
    
    if (storedUser) {
        currentUser = JSON.parse(storedUser);
        
        // Verificar que el usuario a칰n exista en los datos
        const usuarioExistente = usuariosData.find((u) => u.id === currentUser.id);
        
        if (usuarioExistente) {
            // Actualizar datos del usuario actual con los m치s recientes
            currentUser.nombre = usuarioExistente.nombre;
            currentUser.sede = usuarioExistente.sede;
            currentUser.foto = usuarioExistente.foto;
            currentUser.rol = usuarioExistente.rol;
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            
            // Establecer vista guardada o vista por defecto seg칰n rol
            if (storedView) {
                currentView = storedView;
            } else {
                currentView = currentUser.rol === "gerente" 
                    ? "dashboard_gerente" 
                    : currentUser.rol === "asesor" 
                    ? "dashboard_asesor" 
                    : "login";
            }
        } else {
            // Usuario eliminado, cerrar sesi칩n
            currentUser = null;
            currentView = "login";
            localStorage.removeItem("currentUser");
            localStorage.removeItem("currentView");
        }
    } else {
        currentView = "login";
    }
}
async function saveDataToFirebase() {
    if (!db) {
        console.error("Firebase no est치 inicializado");
        saveToLocalStorage(); // Fallback a localStorage
        return false;
    }
    
    try {
        const data = {
            usuarios: usuariosData,
            ventas: ventasData,
            clientes: clientesData,
            presupuestos: presupuestosData,
            lastUpdate: new Date().toISOString(),
            updatedBy: currentUser ? currentUser.nombre : 'system'
        };
        
        await db.collection('sistemaVentas').doc('datosPrincipales').set(data);
        console.log("Datos guardados en Firebase exitosamente");
        return true;
    } catch (error) {
        console.error("Error guardando en Firebase:", error);
        saveToLocalStorage(); // Fallback
        return false;
    }
}

// Funci칩n auxiliar para guardar en localStorage (fallback)
function saveToLocalStorage() {
    const data = {
        usuarios: usuariosData,
        ventas: ventasData,
        clientes: clientesData,
        presupuestos: presupuestosData,
    };
    localStorage.setItem("sistemaVentasData", JSON.stringify(data));
}
async function loadDataFromFirebase() {
    if (!db) {
        console.log("Firebase no disponible, cargando de localStorage");
        loadFromLocalStorage();
        return;
    }
    
    try {
        const doc = await db.collection('sistemaVentas').doc('datosPrincipales').get();
        
        if (doc.exists) {
            const data = doc.data();
            
            // Cargar usuarios
            if (data.usuarios && Array.isArray(data.usuarios)) {
                usuariosData = data.usuarios;
                
                // Verificar que todos los usuarios tengan los campos requeridos
                usuariosData.forEach(usuario => {
                    if (!usuario.hasOwnProperty('foto')) usuario.foto = '';
                    if (!usuario.hasOwnProperty('rol')) usuario.rol = 'asesor';
                });
            } else {
                usuariosData = [...datosIniciales.usuarios];
            }
            
            // Cargar ventas
            if (data.ventas && Array.isArray(data.ventas)) {
                ventasData = data.ventas;
                
                // Asegurar campos requeridos en ventas
                ventasData.forEach(venta => {
                    if (!venta.hasOwnProperty('valor')) venta.valor = 0;
                    if (!venta.hasOwnProperty('mes')) venta.mes = 1;
                    if (!venta.hasOwnProperty('anio')) venta.anio = 2025;
                });
            } else {
                ventasData = [...datosIniciales.ventas];
                ventasData.forEach(venta => {
                    venta.valor = 0;
                });
            }
            
            // Cargar clientes
            if (data.clientes && Array.isArray(data.clientes)) {
                clientesData = data.clientes;
                
                // Asegurar campos requeridos en clientes
                clientesData.forEach(cliente => {
                    if (!cliente.hasOwnProperty('mes')) cliente.mes = 1;
                    if (!cliente.hasOwnProperty('anio')) cliente.anio = 2025;
                });
            } else {
                clientesData = [...datosIniciales.clientes];
            }
            
            // Cargar presupuestos
            if (data.presupuestos && typeof data.presupuestos === 'object') {
                presupuestosData = data.presupuestos;
            } else {
                presupuestosData = {};
            }
            
            console.log("Datos cargados desde Firebase exitosamente");
        } else {
            console.log("No hay datos en Firebase, usando datos iniciales");
            loadInitialData();
        }
    } catch (error) {
        console.error("Error cargando de Firebase:", error);
        loadFromLocalStorage();
    }
}

// Funci칩n auxiliar para cargar de localStorage
function loadFromLocalStorage() {
    const storedData = localStorage.getItem("sistemaVentasData");
    if (storedData) {
        const data = JSON.parse(storedData);
        usuariosData = data.usuarios || datosIniciales.usuarios;
        ventasData = data.ventas || datosIniciales.ventas;
        clientesData = data.clientes || datosIniciales.clientes;
        presupuestosData = data.presupuestos || {};
    } else {
        loadInitialData();
    }
}

// Funci칩n para cargar datos iniciales
function loadInitialData() {
    usuariosData = [...datosIniciales.usuarios];
    ventasData = [...datosIniciales.ventas];
    clientesData = [...datosIniciales.clientes];
    presupuestosData = {};
    
    // A침adir campo valor a ventas iniciales
    ventasData.forEach(venta => {
        venta.valor = 0;
    });
}

        function saveData() {
    // Primero guardar en localStorage (para respuesta inmediata)
    saveToLocalStorage();
    
    // Luego guardar en Firebase (as칤ncrono)
    saveDataToFirebase().then(success => {
        if (success) {
            console.log("Datos sincronizados con Firebase");
        }
    });
    
    return true;
}
        function getPresupuesto(mes, anio, asesor) {
            const key = `${anio}-${mes}-${asesor}`;
            return presupuestosData[key] || 0;
        }

        function setPresupuesto(mes, anio, asesor, monto) {
            const key = `${anio}-${mes}-${asesor}`;
            presupuestosData[key] = parseInt(monto) || 0;
            saveData();
        }
        
        function getPresupuestoProspectos(mes, anio, asesor) {
            const key = `${anio}-${mes}-${asesor}-prospectos`;
            return presupuestosData[key] || 0;
        }


        function setPresupuestoProspectos(mes, anio, asesor, monto) {
            const key = `${anio}-${mes}-${asesor}-prospectos`;
            presupuestosData[key] = parseInt(monto) || 0;
            saveData();
        }

        // VISTA: Editar Presupuestos
function renderEditarPresupuestos() {
    if (!currentUser || currentUser.rol !== "gerente") {
        currentView = "login";
        localStorage.setItem("currentView", currentView);
        render();
        return;
    }

    const meses = {
        '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril',
        '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto',
        '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre'
    };

    const asesores = [
        { id: "DINA LUZ", nombre: "Dina Luz" },
        { id: "FABIOLA", nombre: "Fabiola" },
        { id: "YOLANDA", nombre: "Yolanda" },
        { id: "LINA", nombre: "Lina" },
        { id: "ADRIANA", nombre: "Adriana" },
        { id: "SANDRA", nombre: "Sandra" }
    ];

    const html = `
        <div class="dashboard-container">
            <div class="sidebar">
                <div class="user-info">
                    ${currentUser.foto
                        ? `<img src="${currentUser.foto}" alt="Foto perfil" class="profile-pic">`
                        : `<div class="profile-pic-placeholder">${currentUser.nombre.charAt(0)}</div>`
                    }
                    <h3>${currentUser.nombre}</h3>
                    <p>${currentUser.rol} - ${currentUser.sede}</p>
                </div>
                
                <nav>
                    <ul>
                        <li><a href="#" onclick="navigate('dashboard_gerente')">游늵 Dashboard</a></li>
                        <li><a href="#" onclick="navigate('gestion_asesores')">游논 Gesti칩n de Asesores</a></li>
                        <li><a href="#" onclick="navigate('editar_presupuestos')" class="active">游눯 Editar Presupuestos</a></li>
                        <li><a href="#" onclick="navigate('perfil')">游녻 Perfil</a></li>
                        <li><a href="#" onclick="logout()">游뛁 Salir</a></li>
                    </ul>
                </nav>
            </div>
            
            <div class="main-content">
                <header>
                    <h1>Editar Presupuestos</h1>
                    <div style="color: #666;">
                        <span>Bienvenido, ${currentUser.nombre}</span>
                    </div>
                </header>
                
                <div class="content">
                    ${alertMessage ? `<div class="alert alert-${alertType}">${alertMessage}</div>` : ""}
                    
                    <div class="card">
                        <h2>Seleccionar Mes y A침o</h2>
                        <div style="display: flex; gap: 1rem; margin-bottom: 2rem;">
                            <div class="form-group">
                                <label>A침o:</label>
                                <select id="presupuestoYear" style="width: 200px;">
                                    ${[2025, 2026, 2027, 2028].map(year => 
                                        `<option value="${year}">${year}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mes:</label>
                                <select id="presupuestoMonth" style="width: 200px;">
                                    ${Object.entries(meses).map(([num, nombre]) => 
                                        `<option value="${num}">${nombre}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn" onclick="cargarPresupuestos()">Cargar Presupuestos</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card">
                        <h2 id="tituloPresupuestos">Presupuestos</h2>
                        <div id="formularioPresupuestos">
                            <p style="text-align: center; color: #666; padding: 2rem;">
                                Selecciona un mes y a침o para cargar los presupuestos
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById("app").innerHTML = html;
    
    // Establecer a침o y mes actual
    const today = new Date();
    document.getElementById('presupuestoYear').value = today.getFullYear();
    document.getElementById('presupuestoMonth').value = String(today.getMonth() + 1).padStart(2, '0');
}

// Funci칩n para cargar formulario de presupuestos


function cargarPresupuestos() {
    const year = document.getElementById('presupuestoYear').value;
    const month = document.getElementById('presupuestoMonth').value;
    const monthName = getMeses()[parseInt(month)];
    
    const asesores = [
        { id: "DINA LUZ", nombre: "Dina Luz" },
        { id: "FABIOLA", nombre: "Fabiola" },
        { id: "YOLANDA", nombre: "Yolanda" },
        { id: "LINA", nombre: "Lina" },
        { id: "ADRIANA", nombre: "Adriana" },
        { id: "SANDRA", nombre: "Sandra" }
    ];
    
    let formHTML = `
        <form id="presupuestosForm" onsubmit="return guardarPresupuestos(event)">
            <input type="hidden" name="year" value="${year}">
            <input type="hidden" name="month" value="${month}">
            
            <div style="margin-bottom: 2rem;">
                <h3 style="color: #2c3e50; margin-bottom: 1rem;">Solo Editar estos 3 Campos:</h3>
                <div class="form-grid">
    `;
    
    // Solo PPTO ($) - Ventas en pesos
    asesores.forEach(asesor => {
        const presupuestoActual = getPresupuestoVentas(month, year, asesor.id);
        formHTML += `
            <div class="form-group">
                <label>${asesor.nombre} - PPTO ($):</label>
                <input type="number" 
                       name="ventas_ppto_${asesor.id}" 
                       value="${presupuestoActual}"
                       min="0"
                       step="1000"
                       placeholder="PPTO Ventas en pesos">
            </div>
        `;
    });
    
    formHTML += `
                </div>
                
                <div class="form-grid" style="margin-top: 20px;">
    `;
    
    // Solo PPTO - Efectividad (segundo PPTO)
    asesores.forEach(asesor => {
        const pptoEfectividad = getPresupuestoEfectividad(month, year, asesor.id);
        formHTML += `
            <div class="form-group">
                <label>${asesor.nombre} - PPTO (Efectividad):</label>
                <input type="number" 
                       name="efectividad_ppto_${asesor.id}" 
                       value="${pptoEfectividad}"
                       min="0"
                       step="1"
                       placeholder="PPTO Efectividad">
            </div>
        `;
    });
    
    formHTML += `
                </div>
                
                <div class="form-grid" style="margin-top: 20px;">
    `;
    
    // Nuevo: Tercer PPTO - Prospectos
    asesores.forEach(asesor => {
        const pptoProspectos = getPresupuestoProspectos(month, year, asesor.id);
        formHTML += `
            <div class="form-group">
                <label>${asesor.nombre} - PPTO (Prospectos):</label>
                <input type="number" 
                       name="prospectos_ppto_${asesor.id}" 
                       value="${pptoProspectos}"
                       min="0"
                       step="1"
                       placeholder="PPTO Prospectos">
            </div>
        `;
    });
    
    formHTML += `
                </div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                <button type="submit" class="btn btn-success">游 Guardar los 3 PPTOs</button>
                <button type="button" class="btn btn-secondary" onclick="resetearPresupuestos()">游댃 Restablecer a Cero</button>
            </div>
            
            <div style="margin-top: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px; border-left: 4px solid #667eea;">
                <strong>Nota:</strong> Solo se editan estos 3 campos:<br>
                1. <strong>PPTO ($)</strong> - Ventas en pesos (primera columna)<br>
                2. <strong>PPTO</strong> - Efectividad en cantidad (cuarta columna)<br>
                3. <strong>PPTO</strong> - Prospectos en cantidad (s칠ptima columna)<br><br>
                <strong>NO se editan:</strong> Real ($), Real, % - Estos se calculan autom치ticamente
            </div>
        </form>
    `;
    
    document.getElementById('tituloPresupuestos').textContent = `Editar PPTOs - ${monthName} ${year}`;
    document.getElementById('formularioPresupuestos').innerHTML = formHTML;
}

// Funci칩n para guardar presupuestos
function guardarPresupuestos(event) {
    event.preventDefault();
    
    const formData = new FormData(event.target);
    const year = formData.get('year');
    const month = formData.get('month');
    
    const asesores = ["DINA LUZ", "FABIOLA", "YOLANDA", "LINA", "ADRIANA", "SANDRA"];
    
    // Guardar los 3 campos editables
    asesores.forEach(asesor => {
        // Solo PPTO ($) - Ventas
        const ventasPpto = formData.get(`ventas_ppto_${asesor}`) || 0;
        setPresupuestoVentas(month, year, asesor, ventasPpto);
        
        // Solo PPTO - Efectividad
        const efectividadPpto = formData.get(`efectividad_ppto_${asesor}`) || 0;
        setPresupuestoEfectividad(month, year, asesor, efectividadPpto);
        
        // Tercer PPTO - Prospectos
        const prospectosPpto = formData.get(`prospectos_ppto_${asesor}`) || 0;
        setPresupuestoProspectos(month, year, asesor, prospectosPpto);
    });
    
    showAlert(`Los 3 PPTOs guardados exitosamente para ${getMeses()[parseInt(month)]} ${year}`, "success");
    
    // Recargar formulario con nuevos valores
    setTimeout(() => {
        cargarPresupuestos();
    }, 500);
    
    return false;
}

// Funci칩n para resetear presupuestos

function resetearPresupuestos() {
    if (confirm("쮼st치 seguro de restablecer los 3 PPTOs a cero?")) {
        const form = document.getElementById('presupuestosForm');
        if (form) {
            const inputs = form.querySelectorAll('input[type="number"]');
            inputs.forEach(input => {
                input.value = 0;
            });
            
            const year = form.querySelector('input[name="year"]').value;
            const month = form.querySelector('input[name="month"]').value;
            const monthName = getMeses()[parseInt(month)];
            
            showAlert(`Los 3 PPTOs restablecidos a cero para ${monthName} ${year}`, "info");
        }
    }
}

function getPresupuestoVentas(mes, anio, asesor) {
    const key = `${anio}-${mes}-${asesor}-ventas`;
    return presupuestosData[key] || 0;
}

function setPresupuestoVentas(mes, anio, asesor, monto) {
    const key = `${anio}-${mes}-${asesor}-ventas`;
    presupuestosData[key] = parseInt(monto) || 0;
    saveData(); // Esta funci칩n ahora guarda en Firebase tambi칠n
}

function getRealVentas(mes, anio, asesor) {
    const key = `${anio}-${mes}-${asesor}-real-ventas`;
    return presupuestosData[key] || 0;
}

function setRealVentas(mes, anio, asesor, monto) {
    const key = `${anio}-${mes}-${asesor}-real-ventas`;
    presupuestosData[key] = parseInt(monto) || 0;
    saveData();
}

function getPresupuestoEfectividad(mes, anio, asesor) {
    const key = `${anio}-${mes}-${asesor}-efectividad`;
    return presupuestosData[key] || 0;
}

function setPresupuestoEfectividad(mes, anio, asesor, monto) {
    const key = `${anio}-${mes}-${asesor}-efectividad`;
    presupuestosData[key] = parseInt(monto) || 0;
    saveData(); // Esta funci칩n ahora guarda en Firebase tambi칠n
}

function getRealEfectividad(mes, anio, asesor) {
    const key = `${anio}-${mes}-${asesor}-real-efectividad`;
    return presupuestosData[key] || 0;
}

function setRealEfectividad(mes, anio, asesor, monto) {
    const key = `${anio}-${mes}-${asesor}-real-efectividad`;
    presupuestosData[key] = parseInt(monto) || 0;
    saveData();
}

function getPresupuestoProspectos(mes, anio, asesor) {
    const key = `${anio}-${mes}-${asesor}-prospectos`;
    return presupuestosData[key] || 0;
}

function setPresupuestoProspectos(mes, anio, asesor, monto) {
    const key = `${anio}-${mes}-${asesor}-prospectos`;
    presupuestosData[key] = parseInt(monto) || 0;
    saveData(); // Esta funci칩n ahora guarda en Firebase tambi칠n
}

function getRealProspectos(mes, anio, asesor) {
    const key = `${anio}-${mes}-${asesor}-real-prospectos`;
    return presupuestosData[key] || 0;
}

function setRealProspectos(mes, anio, asesor, monto) {
    const key = `${anio}-${mes}-${asesor}-real-prospectos`;
    presupuestosData[key] = parseInt(monto) || 0;
    saveData();
}

function calcularVentasReales(mes, anio, asesor) {
    // Filtrar ventas del asesor en el mes/a침o espec칤fico
    const ventasAsesor = ventasData.filter(v => 
        v.asesor.toUpperCase() === asesor.toUpperCase() &&
        v.mes === parseInt(mes) &&
        v.anio === parseInt(anio)
    );
    
    // Calcular suma de valores
    let sumaValores = 0;
    ventasAsesor.forEach(venta => {
        sumaValores += venta.valor || 0;
    });
    
    return {
        cantidad: ventasAsesor.length,
        valorTotal: sumaValores
    };
}


function cargarRegistrosRecientes() {
    const tablaContainer = document.getElementById('tablaRegistrosRecientes');
    if (!tablaContainer) return;
    
    // Filtrar registros del asesor actual
    const registrosAsesor = [
        ...clientesData.filter(c => c.asesor.toUpperCase() === currentUser.nombre.toUpperCase()),
        ...ventasData.filter(v => v.asesor.toUpperCase() === currentUser.nombre.toUpperCase())
    ];
    
    // Ordenar por fecha (m치s recientes primero)
    registrosAsesor.sort((a, b) => {
        return b.id - a.id; // Ordenar por ID (mayor = m치s reciente)
    });
    
    // Tomar los 칰ltimos 10 registros
    const registrosRecientes = registrosAsesor.slice(0, 10);
    
    if (registrosRecientes.length === 0) {
        tablaContainer.innerHTML = `
            <p style="text-align: center; color: #666; padding: 2rem;">
                No tienes registros a칰n. 춰Comienza ingresando tu primer cliente o venta!
            </p>
        `;
        return;
    }
    
    let html = `
        <div class="table-responsive">
            <table class="data-table">
                <thead>
                    <tr>
                        <th>Tipo</th>
                        <th>Cliente</th>
                        <th>Veh칤culo</th>
                        <th>Referencia</th>
                        <th>Fecha/Mes</th>
                        <th>Valor/Estado</th>
                        <th>Acciones</th>
                    </tr>
                </thead>
                <tbody>
    `;
    
    registrosRecientes.forEach(registro => {
        const esVenta = 'valor' in registro;
        const mesNombre = getMeses()[registro.mes] || 'Desconocido';
        
        html += `
            <tr>
                <td>
                    <span class="badge ${esVenta ? 'badge-success' : 'badge-info'}">
                        ${esVenta ? 'VENTA' : 'CLIENTE'}
                    </span>
                </td>
                <td>${registro.nombre || registro.cliente}</td>
                <td>${registro.tipo || registro.tipoVehiculo}</td>
                <td>${registro.referencia}</td>
                <td>${mesNombre} ${registro.anio}</td>
                <td>${esVenta ? `$${(registro.valor || 0).toLocaleString()}` : 'Prospecto'}</td>
                <td>
                    <button class="btn btn-small" onclick="editarRegistro(${registro.id})">
                        九勇 ${esVenta ? 'Editar' : 'Convertir'}
                    </button>
                </td>
            </tr>
        `;
    });
    
    html += `
                </tbody>
            </table>
        </div>
        <p style="margin-top: 10px; color: #666; font-size: 0.9rem;">
            <i>Nota: Puedes editar ventas o convertir clientes en ventas cuando completen su compra</i>
        </p>
    `;
    
    tablaContainer.innerHTML = html;
}

function editarRegistro(id) {
    // Buscar el registro
    let registro = ventasData.find(v => v.id === id);
    let esVenta = true;
    
    if (!registro) {
        registro = clientesData.find(c => c.id === id);
        esVenta = false;
    }
    
    if (!registro) {
        showAlert("Registro no encontrado", "error");
        return;
    }
    
    // Guardar el ID en una variable global y navegar
    window.ventaIdParaEditar = id;
    currentView = "editar_venta";
    localStorage.setItem("currentView", currentView);
    render();
}

function renderEditarVenta(ventaId) {
    if (!currentUser || currentUser.rol !== "asesor") {
        currentView = "login";
        localStorage.setItem("currentView", currentView);
        render();
        return;
    }

    // Buscar la venta/cliente
    let registro;
    let esVenta = false;
    
    // Buscar primero en ventas
    registro = ventasData.find(v => v.id === ventaId);
    if (registro) {
        esVenta = true;
    } else {
        // Buscar en clientes (prospectos)
        registro = clientesData.find(c => c.id === ventaId);
    }

    if (!registro) {
        showAlert("Registro no encontrado", "error");
        navigate('ingresar_ventas');
        return;
    }

    const html = `
        <div class="dashboard-container">
            <div class="sidebar">
                <div class="user-info">
                    ${currentUser.foto
                        ? `<img src="${currentUser.foto}" alt="Foto perfil" class="profile-pic">`
                        : `<div class="profile-pic-placeholder">${currentUser.nombre.charAt(0)}</div>`
                    }
                    <h3>${currentUser.nombre}</h3>
                    <p>Asesor - ${currentUser.sede}</p>
                </div>
                
                <nav>
                    <ul>
                        <li><a href="#" onclick="navigate('ingresar_ventas')">俱 Ingresar Ventas</a></li>
                        <li><a href="#" onclick="navigate('dashboard_asesor')">游늵 Dashboard</a></li>
                        <li><a href="#" onclick="navigate('perfil')">游녻 Perfil</a></li>
                        <li><a href="#" onclick="logout()">游뛁 Salir</a></li>
                    </ul>
                </nav>
            </div>
            
            <div class="main-content">
                <header>
                    <h1>九勇 ${esVenta ? 'Editar Venta' : 'Convertir Cliente a Venta'}</h1>
                    <div style="color: #666;">
                        <span>Asesor: ${currentUser.nombre} - Sede: ${currentUser.sede}</span>
                    </div>
                </header>
                
                <div class="content">
                    ${alertMessage ? `<div class="alert alert-${alertType}">${alertMessage}</div>` : ""}
                    
                    <div class="card">
                        <h2>${esVenta ? 'Editar informaci칩n de venta' : 'Convertir prospecto a venta realizada'}</h2>
                        <form id="editarVentaForm" onsubmit="return guardarEdicionVenta(event, ${ventaId}, ${esVenta})">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Tipo de Registro:</label>
                                    <select id="editarTipoRegistro" required onchange="mostrarCampoValorEditar()">
                                        <option value="cliente" ${!esVenta ? 'selected' : ''}>Solo Cliente</option>
                                        <option value="venta" ${esVenta ? 'selected' : ''}>Venta Realizada</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="editarValorVehiculoContainer" style="${esVenta ? 'display: block;' : 'display: none;'}">
                                    <label>Valor del Veh칤culo ($):</label>
                                    <input type="number" id="editarValorVehiculo" min="0" step="1000" 
                                           value="${esVenta ? (registro.valor || 0) : 0}" 
                                           ${esVenta ? 'required' : ''} 
                                           placeholder="Ingrese valor en pesos">
                                </div>
                                
                                <div class="form-group">
                                    <label>Nombre del Cliente:</label>
                                    <input type="text" id="editarNombreCliente" value="${registro.nombre || registro.cliente}" required placeholder="Nombre completo">
                                </div>
                                
                                <div class="form-group">
                                    <label>C칠dula:</label>
                                    <input type="text" id="editarCedulaCliente" value="${registro.cedula || ''}" placeholder="N칰mero de c칠dula">
                                </div>
                                
                                <div class="form-group">
                                    <label>Celular:</label>
                                    <input type="text" id="editarCelularCliente" value="${registro.celular}" required placeholder="N칰mero de celular">
                                </div>
                                
                                <div class="form-group">
                                    <label>Tipo de Veh칤culo:</label>
                                    <select id="editarTipoVehiculo" required>
                                        <option value="">Seleccionar</option>
                                        <option value="moto" ${(registro.tipo === 'moto' || registro.tipoVehiculo === 'moto') ? 'selected' : ''}>Moto</option>
                                        <option value="patineta" ${(registro.tipo === 'patineta' || registro.tipoVehiculo === 'patineta') ? 'selected' : ''}>Patineta</option>
                                        <option value="carro" ${(registro.tipo === 'carro' || registro.tipoVehiculo === 'carro') ? 'selected' : ''}>Carro</option>
                                        <option value="bicicleta" ${(registro.tipo === 'bicicleta' || registro.tipoVehiculo === 'bicicleta') ? 'selected' : ''}>Bicicleta</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Referencia:</label>
                                    <input type="text" id="editarReferenciaVehiculo" value="${registro.referencia}" required placeholder="Modelo o referencia">
                                </div>
                                
                                <div class="form-group">
                                    <label>Agencia:</label>
                                    <select id="editarAgenciaVenta" required>
                                        <option value="">Seleccionar</option>
                                        <option value="Cra 33 Cabecera" ${(registro.agencia === 'Cra 33 Cabecera') ? 'selected' : ''}>Cra 33 Cabecera</option>
                                        <option value="Giron" ${(registro.agencia === 'Giron') ? 'selected' : ''}>Giron</option>
                                        <option value="Barrancabermeja" ${(registro.agencia === 'Barrancabermeja') ? 'selected' : ''}>Barrancabermeja</option>
                                        <option value="La Concordia" ${(registro.agencia === 'La Concordia') ? 'selected' : ''}>La Concordia</option>
                                        <option value="Valledupar" ${(registro.agencia === 'Valledupar') ? 'selected' : ''}>Valledupar</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Fuente:</label>
                                    <select id="editarFuenteCliente" required>
                                        <option value="">Seleccionar</option>
                                        <option value="sala" ${registro.fuente === 'sala' ? 'selected' : ''}>Sala</option>
                                        <option value="digital" ${registro.fuente === 'digital' ? 'selected' : ''}>Digital</option>
                                        <option value="referido" ${registro.fuente === 'referido' ? 'selected' : ''}>Referido</option>
                                        <option value="playa" ${registro.fuente === 'playa' ? 'selected' : ''}>Playa</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Clasificaci칩n:</label>
                                    <select id="editarClasificacionCliente" required>
                                        <option value="">Seleccionar</option>
                                        <option value="exploracion" ${registro.clasificacion === 'exploracion' ? 'selected' : ''}>Exploraci칩n</option>
                                        <option value="evaluacion" ${registro.clasificacion === 'evaluacion' ? 'selected' : ''}>Evaluaci칩n</option>
                                        <option value="decision" ${registro.clasificacion === 'decision' ? 'selected' : ''}>Decisi칩n</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Tipo de Cliente:</label>
                                    <select id="editarTipoCliente" required>
                                        <option value="">Seleccionar</option>
                                        <option value="no-moto" ${registro.tipoCliente === 'no-moto' ? 'selected' : ''}>Cliente no moto el칠ctrica</option>
                                        <option value="cm" ${registro.tipoCliente === 'cm' ? 'selected' : ''}>Cliente ciudad movil</option>
                                        <option value="no-cm" ${registro.tipoCliente === 'no-cm' ? 'selected' : ''}>Cliente de otra marca</option>
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>Mes de la venta:</label>
                                    <select id="editarMesVenta" required>
                                        ${Object.entries(getMeses()).map(([num, nombre]) => 
                                            `<option value="${num}" ${parseInt(num) === (registro.mes || 1) ? 'selected' : ''}>${nombre}</option>`
                                        ).join('')}
                                    </select>
                                </div>

                                <div class="form-group">
                                    <label>A침o de la venta:</label>
                                    <select id="editarAnioVenta" required>
                                        ${[2025, 2026, 2027, 2028].map(year => 
                                            `<option value="${year}" ${year === (registro.anio || 2025) ? 'selected' : ''}>${year}</option>`
                                        ).join('')}
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                                <button type="submit" class="btn btn-success">游 ${esVenta ? 'Guardar Cambios' : 'Convertir a Venta'}</button>
                                <button type="button" class="btn btn-secondary" onclick="navigate('ingresar_ventas')">뾆잺 Volver</button>
                                ${!esVenta ? `<button type="button" class="btn btn-warning" onclick="eliminarRegistro(${ventaId}, 'cliente')">游딈勇 Eliminar Cliente</button>` : ''}
                                ${esVenta ? `<button type="button" class="btn btn-danger" onclick="eliminarRegistro(${ventaId}, 'venta')">游딈勇 Eliminar Venta</button>` : ''}
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById("app").innerHTML = html;
}


function mostrarCampoValorEditar() {
    const tipoRegistro = document.getElementById('editarTipoRegistro').value;
    const valorContainer = document.getElementById('editarValorVehiculoContainer');
    
    if (tipoRegistro === 'venta') {
        valorContainer.style.display = 'block';
        document.getElementById('editarValorVehiculo').required = true;
    } else {
        valorContainer.style.display = 'none';
        document.getElementById('editarValorVehiculo').required = false;
    }
}


function guardarEdicionVenta(event, ventaId, esVentaActual) {
    event.preventDefault();
    
    const tipoRegistro = document.getElementById('editarTipoRegistro').value;
    const nombreCliente = document.getElementById('editarNombreCliente').value;
    const cedulaCliente = document.getElementById('editarCedulaCliente').value;
    const celularCliente = document.getElementById('editarCelularCliente').value;
    const tipoVehiculo = document.getElementById('editarTipoVehiculo').value;
    const referenciaVehiculo = document.getElementById('editarReferenciaVehiculo').value;
    const agenciaVenta = document.getElementById('editarAgenciaVenta').value;
    const fuenteCliente = document.getElementById('editarFuenteCliente').value;
    const clasificacionCliente = document.getElementById('editarClasificacionCliente').value;
    const tipoCliente = document.getElementById('editarTipoCliente').value;
    const mesVenta = parseInt(document.getElementById('editarMesVenta').value);
    const anioVenta = parseInt(document.getElementById('editarAnioVenta').value);
    
    // Validar valor de venta si es tipo venta
    let valorVenta = 0;
    if (tipoRegistro === 'venta') {
        valorVenta = parseInt(document.getElementById('editarValorVehiculo').value) || 0;
        
        if (valorVenta <= 0) {
            showAlert("Debe ingresar un valor v치lido para la venta", "error");
            return false;
        }
    }
    
    // Obtener fecha actual
    const today = new Date();
    const fecha = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
    
    if (esVentaActual) {
        // Caso 1: Ya es una venta, estamos editando
        if (tipoRegistro === 'venta') {
            // Actualizar la venta existente
            const ventaIndex = ventasData.findIndex(v => v.id === ventaId);
            if (ventaIndex !== -1) {
                ventasData[ventaIndex] = {
                    ...ventasData[ventaIndex],
                    cliente: nombreCliente,
                    cedula: cedulaCliente,
                    celular: celularCliente,
                    tipo: tipoVehiculo,
                    referencia: referenciaVehiculo,
                    agencia: agenciaVenta,
                    fuente: fuenteCliente,
                    clasificacion: clasificacionCliente,
                    tipoCliente: tipoCliente,
                    valor: valorVenta,
                    mes: mesVenta,
                    anio: anioVenta
                };
            }
        } else {
            // Convertir venta a cliente (prospecto) - caso raro pero posible
            // 1. Eliminar de ventas
            const nuevaVentaIndex = ventasData.findIndex(v => v.id === ventaId);
            if (nuevaVentaIndex !== -1) {
                ventasData.splice(nuevaVentaIndex, 1);
            }
            
            // 2. Crear cliente
            const nuevoCliente = {
                id: clientesData.length + 1,
                asesor: currentUser.nombre.toUpperCase(),
                fecha: fecha,
                nombre: nombreCliente,
                cedula: cedulaCliente,
                celular: celularCliente,
                email: "",
                tipoCliente: tipoCliente,
                fuente: fuenteCliente,
                tipoVehiculo: tipoVehiculo,
                referencia: referenciaVehiculo,
                formaPago: "Prospecto",
                mes: mesVenta,
                anio: anioVenta
            };
            
            clientesData.push(nuevoCliente);
        }
    } else {
        // Caso 2: Es un cliente (prospecto)
        if (tipoRegistro === 'venta') {
            // Convertir cliente a venta
            // 1. Eliminar de clientes
            const clienteIndex = clientesData.findIndex(c => c.id === ventaId);
            if (clienteIndex !== -1) {
                clientesData.splice(clienteIndex, 1);
            }
            
            // 2. Crear venta con valor
            const nuevaVenta = {
                id: ventasData.length + 1,
                asesor: currentUser.nombre.toUpperCase(),
                cliente: nombreCliente,
                cedula: cedulaCliente,
                celular: celularCliente,
                tipo: tipoVehiculo,
                referencia: referenciaVehiculo,
                agencia: agenciaVenta,
                fuente: fuenteCliente,
                clasificacion: clasificacionCliente,
                tipoCliente: tipoCliente,
                valor: valorVenta,
                mes: mesVenta,
                anio: anioVenta
            };
            
            ventasData.push(nuevaVenta);
        } else {
            // Actualizar cliente existente
            const clienteIndex = clientesData.findIndex(c => c.id === ventaId);
            if (clienteIndex !== -1) {
                clientesData[clienteIndex] = {
                    ...clientesData[clienteIndex],
                    nombre: nombreCliente,
                    cedula: cedulaCliente,
                    celular: celularCliente,
                    tipoCliente: tipoCliente,
                    fuente: fuenteCliente,
                    tipoVehiculo: tipoVehiculo,
                    referencia: referenciaVehiculo,
                    formaPago: "Prospecto",
                    mes: mesVenta,
                    anio: anioVenta
                };
            }
        }
    }
    
    // Guardar cambios
    saveData();
    
    // Mostrar mensaje
    const mensaje = tipoRegistro === 'venta' 
        ? `九 ${esVentaActual ? 'Venta actualizada' : 'Cliente convertido a venta'} por $${valorVenta.toLocaleString()} - Se actualizar치 en el dashboard`
        : '九 Cliente actualizado como prospecto';
    
    showAlert(mensaje, "success");
    
    // Limpiar variable global
    window.ventaIdParaEditar = null;
    
    // Redirigir a la vista de ingresar ventas
    setTimeout(() => {
        navigate('ingresar_ventas');
    }, 1500);
    
    return false;
}


function eliminarRegistro(id, tipo) {
    if (!confirm(`쮼st치 seguro de eliminar este ${tipo === 'venta' ? 'venta' : 'cliente'}? Esta acci칩n no se puede deshacer.`)) {
        return;
    }
    
    if (tipo === 'venta') {
        // Eliminar venta
        const ventaIndex = ventasData.findIndex(v => v.id === id);
        if (ventaIndex !== -1) {
            ventasData.splice(ventaIndex, 1);
        }
    } else {
        // Eliminar cliente
        const clienteIndex = clientesData.findIndex(c => c.id === id);
        if (clienteIndex !== -1) {
            clientesData.splice(clienteIndex, 1);
        }
    }
    
    saveData();
    showAlert(`${tipo === 'venta' ? 'Venta' : 'Cliente'} eliminado exitosamente`, "success");
    
    // Limpiar variable global
    window.ventaIdParaEditar = null;
    
    // Redirigir
    setTimeout(() => {
        navigate('ingresar_ventas');
    }, 1000);
}
        // ==================== VISTAS ====================

        // VISTA: Login
        function renderLogin() {
            let selectedRole = "asesor";

            const html = `
                <div class="login-container">
                    <div class="login-box">
                        <h1>游끽 Sistema de Ventas</h1>
                        <h2>Iniciar Sesi칩n</h2>
                        
                        ${alertMessage ? `<div class="alert alert-${alertType}">${alertMessage}</div>` : ""}
                        
                        <div class="role-selector">
                            <div class="role-option ${selectedRole === "gerente" ? "selected" : ""}" onclick="selectLoginRole('gerente')" id="roleGerente">
                                <div class="role-icon">游녮</div>
                                <div>Gerente</div>
                            </div>
                            <div class="role-option ${selectedRole === "asesor" ? "selected" : ""}" onclick="selectLoginRole('asesor')" id="roleAsesor">
                                <div class="role-icon">游놀꽳눺</div>
                                <div>Asesor</div>
                            </div>
                            <div class="role-option ${selectedRole === "cliente" ? "selected" : ""}" onclick="selectLoginRole('cliente')" id="roleCliente">
                                <div class="role-icon">游녻</div>
                                <div>Cliente</div>
                            </div>
                        </div>
                        
                        <form onsubmit="return handleLogin(event)">
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <label for="username">Usuario:</label>
                                    <input type="text" id="username" name="username" required>
                                </div>
                                
                                <div class="form-group">
                                    <label for="password">Contrase침a:</label>
                                    <input type="password" id="password" name="password" required>
                                </div>
                            </div>
                            
                            <button type="submit" class="btn" style="width: 100%; margin-top: 1rem;">Iniciar Sesi칩n</button>
                        </form>
                        
                        <div style="margin-top: 2rem; text-align: center;">
                            <p>쯅o tienes una cuenta?</p>
                            <button class="btn btn-register" onclick="mostrarRegistro()">游닇 Registrar Usuario</button>
                        </div>
                    </div>
                </div>
                
                <!-- Modal para registro -->
                <div class="modal" id="registroModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Registrar Nuevo Usuario</h2>
                            <button class="close-modal" onclick="cerrarModalRegistro()">칑</button>
                        </div>
                        
                        <div id="registroAlert"></div>
                        
                        <form id="registroForm" onsubmit="return handleRegistro(event)">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Clave de Seguridad:</label>
                                    <input type="password" id="securityKey" required>
                                    <small style="color: #666;">Clave requerida para registrar usuarios</small>
                                </div>
                            </div>
                            
                            <div class="form-horizontal">
                                <div class="form-group">
                                    <label>Rol:</label>
                                    <select id="registroRol" required>
                                        <option value="">Seleccionar rol</option>
                                        <option value="gerente">Gerente</option>
                                        <option value="asesor">Asesor</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Usuario:</label>
                                    <input type="text" id="registroUsername" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>Nombre Completo:</label>
                                    <input type="text" id="registroNombre" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>Contrase침a:</label>
                                    <input type="password" id="registroPassword" required>
                                </div>
                                
                                <div class="form-group">
                                    <label>Sede:</label>
                                    <select id="registroSede" required>
                                        <option value="">Seleccionar sede</option>
                                        ${getSedes()
                    .map(
                        (sede) =>
                            `<option value="${sede}">${sede}</option>`,
                    )
                    .join("")}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Confirmar Contrase침a:</label>
                                    <input type="password" id="registroConfirmPassword" required>
                                </div>
                            </div>
                            
                            <div style="margin-top: 1.5rem;">
                                <button type="submit" class="btn btn-success" style="width: 100%;">Registrar Usuario</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById("app").innerHTML = html;

            // Establecer rol por defecto
            selectLoginRole("asesor");

            // Actualizar alerta del modal si existe
            if (registroAlertMessage) {
                actualizarModalRegistro();
            }
        }

        function selectLoginRole(role) {
    const roles = ["gerente", "asesor", "cliente"];
    roles.forEach((r) => {
        const element = document.getElementById(
            "role" + r.charAt(0).toUpperCase() + r.slice(1),
        );
        if (element) {
            element.classList.remove("selected");
        }
    });

    const selectedElement = document.getElementById(
        "role" + role.charAt(0).toUpperCase() + role.slice(1),
    );
    if (selectedElement) {
        selectedElement.classList.add("selected");
    }

    // Guardar rol seleccionado en variable global
    window.selectedLoginRole = role;

    // Si seleccionan cliente, abrir en nueva pesta침a inmediatamente
    if (role === "cliente") {
        setTimeout(() => {
            window.open("https://ciudadmovilcolombia.com/mi-cuenta/", "_blank");
        }, 300); // Peque침o delay para que se vea el cambio visual
    }
}

        function handleLogin(event) {
    event.preventDefault();

    const username = document.getElementById("username").value;
    const password = document.getElementById("password").value;
    const selectedRole = window.selectedLoginRole || "asesor";

    // Si es cliente, redirigir directamente al sitio externo
    // SIN siquiera validar el formulario
    if (selectedRole === "cliente") {
        window.location.href = "https://ciudadmovilcolombia.com/mi-cuenta/";
        return false;
    }

    // Si es gerente o asesor, continuar con la validaci칩n normal
    const usuario = usuariosData.find(
        (u) =>
            u.username.toLowerCase() === username.toLowerCase() &&
            u.password === password,
    );

    if (usuario) {
        // Verificar rol
        if (usuario.rol !== selectedRole) {
            showAlert(
                `Este usuario no tiene rol de ${selectedRole}. Seleccione el rol correcto.`,
                "error",
            );
            return false;
        }

        // Guardar usuario actual
        currentUser = {
            id: usuario.id,
            username: usuario.username,
            nombre: usuario.nombre,
            rol: usuario.rol,
            sede: usuario.sede,
            foto: usuario.foto,
        };
        localStorage.setItem("currentUser", JSON.stringify(currentUser));

        // Establecer vista inicial seg칰n rol
        if (usuario.rol === "gerente") {
            currentView = "dashboard_gerente";
        } else if (usuario.rol === "asesor") {
            currentView = "dashboard_asesor";
        }

        // Guardar vista actual en localStorage
        localStorage.setItem("currentView", currentView);

        showAlert(`춰Bienvenido, ${usuario.nombre}!`, "success");
        render();
    } else {
        showAlert("Usuario o contrase침a incorrectos", "error");
    }

    return false;
}

        function mostrarRegistro() {
            document.getElementById("registroModal").style.display = "flex";
            // Limpiar mensaje anterior
            registroAlertMessage = null;
            registroAlertType = null;
        }

        function cerrarModalRegistro() {
            document.getElementById("registroModal").style.display = "none";
            // Limpiar formulario
            document.getElementById("registroForm").reset();
            // Limpiar mensaje
            registroAlertMessage = null;
            registroAlertType = null;
        }

        function handleRegistro(event) {
            event.preventDefault();

            const securityKey = document.getElementById("securityKey").value;
            const rol = document.getElementById("registroRol").value;
            const username = document.getElementById("registroUsername").value;
            const nombre = document.getElementById("registroNombre").value;
            const password = document.getElementById("registroPassword").value;
            const confirmPassword = document.getElementById(
                "registroConfirmPassword",
            ).value;
            const sede = document.getElementById("registroSede").value;

            // Validar clave de seguridad
            if (securityKey !== SECURITY_KEY) {
                showRegistroAlert(
                    "Clave de seguridad incorrecta. No tiene permisos para registrar usuarios.",
                    "error",
                );
                return false;
            }

            // Validar que se haya seleccionado un rol
            if (!rol) {
                showRegistroAlert(
                    "Por favor seleccione un rol para el usuario.",
                    "error",
                );
                return false;
            }

            // Validar que las contrase침as coincidan
            if (password !== confirmPassword) {
                showRegistroAlert("Las contrase침as no coinciden", "error");
                return false;
            }

            // Validar que el usuario no exista
            const usuarioExistente = usuariosData.find(
                (u) => u.username.toLowerCase() === username.toLowerCase(),
            );
            if (usuarioExistente) {
                showRegistroAlert("El nombre de usuario ya existe", "error");
                return false;
            }

            // Crear nuevo usuario
            const nuevoUsuario = {
                id: usuariosData.length + 1,
                username: username,
                password: password,
                nombre: nombre,
                rol: rol,
                sede: sede,
                foto: "",
            };

            usuariosData.push(nuevoUsuario);
            saveData();

            // Cerrar modal y mostrar mensaje
            cerrarModalRegistro();
            showAlert(
                `Usuario ${nombre} registrado exitosamente como ${rol}`,
                "success",
            );

            return false;
        }

        // VISTA: Dashboard Gerente
        function renderDashboardGerente() {
            if (!currentUser || currentUser.rol !== "gerente") {
                currentView = "login";
                localStorage.setItem("currentView", currentView);
                render();
                return;
            }

            const html = `
                <div class="dashboard-container">
                    <div class="sidebar">
                        <div class="user-info">
                            ${currentUser.foto
                    ? `<img src="${currentUser.foto}" alt="Foto perfil" class="profile-pic">`
                    : `<div class="profile-pic-placeholder">${currentUser.nombre.charAt(0)}</div>`
                }
                            <h3>${currentUser.nombre}</h3>
                            <p>${currentUser.rol} - ${currentUser.sede}</p>
                        </div>
                        
                        <nav>
<ul>
        <li><a href="#" onclick="navigate('dashboard_gerente')" class="active">游늵 Dashboard</a></li>
        <li><a href="#" onclick="navigate('gestion_asesores')">游논 Gesti칩n de Asesores</a></li>
        <li><a href="#" onclick="navigate('editar_presupuestos')">游눯 Editar Presupuestos</a></li>
        <li><a href="#" onclick="navigate('perfil')">游녻 Perfil</a></li>
        <li><a href="#" onclick="logout()">游뛁 Salir</a></li>
    </ul>
</nav>
                    </div>
                    
                    <div class="main-content">
                        <header>
                            <h1>Dashboard - Gerente</h1>
                            <div style="color: #666;">
                                <span>Bienvenido, ${currentUser.nombre}</span>
                            </div>
                        </header>
                        
                        <div class="content">
                            ${alertMessage ? `<div class="alert alert-${alertType}">${alertMessage}</div>` : ""}
                            <div style="margin-bottom: 20px;">
                                <select id="yearFilter" style="padding: 10px; margin-right: 10px;">
                                    <option value="">A침o</option>
                                </select>

                                <select id="monthFilter" style="padding: 10px;">
                                    <option value="">Mes</option>
                                    <option value="01">Enero</option>
                                    <option value="02">Febrero</option>
                                    <option value="03">Marzo</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Mayo</option>
                                    <option value="06">Junio</option>
                                    <option value="07">Julio</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                           
                            <div id="dashboardContent"></div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById("app").innerHTML = html;
            
            // Inicializar los filtros despu칠s de renderizar
            setTimeout(initializeDashboardFilters, 100);
        }

        // VISTA: Gesti칩n de Asesores
        function renderGestionAsesores() {
            if (!currentUser || currentUser.rol !== "gerente") {
                currentView = "login";
                localStorage.setItem("currentView", currentView);
                render();
                return;
            }

            // Filtrar solo asesores
            const asesores = usuariosData.filter((u) => u.rol === "asesor");

            const html = `
                <div class="dashboard-container">
                    <div class="sidebar">
                        <div class="user-info">
                            ${currentUser.foto
                    ? `<img src="${currentUser.foto}" alt="Foto perfil" class="profile-pic">`
                    : `<div class="profile-pic-placeholder">${currentUser.nombre.charAt(0)}</div>`
                }
                            <h3>${currentUser.nombre}</h3>
                            <p>${currentUser.rol} - ${currentUser.sede}</p>
                        </div>
                        
                        <nav>
                            <ul>
                                <li><a href="#" onclick="navigate('dashboard_gerente')">游늵 Dashboard</a></li>
                                <li><a href="#" onclick="navigate('gestion_asesores')" class="active">游논 Gesti칩n de Asesores</a></li>
                                <li><a href="#" onclick="navigate('perfil')">游녻 Perfil</a></li>
                                <li><a href="#" onclick="logout()">游뛁 Salir</a></li>
                            </ul>
                        </nav>
                    </div>
                    
                    <div class="main-content">
                        <header>
                            <h1>Gesti칩n de Asesores</h1>
                            <div style="color: #666;">
                                <span>Bienvenido, ${currentUser.nombre}</span>
                            </div>
                        </header>
                        
                        <div class="content">
                            ${alertMessage ? `<div class="alert alert-${alertType}">${alertMessage}</div>` : ""}
                            
                            <div class="card">
                                <h2>Crear Nuevo Asesor</h2>
                                
                                <form id="createAsesorForm" class="form-grid" onsubmit="return crearAsesor(event)">
                                    <div class="form-group">
                                        <label>Usuario:</label>
                                        <input type="text" name="username" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Nombre:</label>
                                        <input type="text" name="nombre" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Contrase침a:</label>
                                        <input type="password" name="password" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Sede:</label>
                                        <select name="sede" required>
                                            <option value="">Seleccionar sede</option>
                                            ${getSedes()
                    .map(
                        (sede) =>
                            `<option value="${sede}">${sede}</option>`,
                    )
                    .join("")}
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <button type="submit" class="btn">Crear Asesor</button>
                                    </div>
                                </form>
                            </div>
                            
                            <div class="card">
                                <h2>Asesores Registrados</h2>
                                <div class="table-responsive">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Usuario</th>
                                                <th>Nombre</th>
                                                <th>Sede</th>
                                                <th>Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${asesores
                    .map(
                        (asesor) => `
                                                <tr>
                                                    <td>${asesor.id}</td>
                                                    <td>${asesor.username}</td>
                                                    <td>${asesor.nombre}</td>
                                                    <td>${asesor.sede}</td>
                                                    <td>
                                                        <button class="btn btn-small" onclick="editarAsesor(${asesor.id})">Editar</button>
                                                        <button class="btn btn-small btn-danger" onclick="eliminarAsesor(${asesor.id})">Eliminar</button>
                                                    </td>
                                                </tr>
                                            `,
                    )
                    .join("")}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Modal para editar asesor -->
                <div class="modal" id="editAsesorModal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h2>Editar Asesor</h2>
                            <button class="close-modal" onclick="cerrarModal()">칑</button>
                        </div>
                        <form id="editAsesorForm" class="form-grid" onsubmit="return guardarAsesor(event)">
                            <input type="hidden" id="editAsesorId" name="id">
                            <div class="form-group">
                                <label>Usuario:</label>
                                <input type="text" id="editAsesorUsername" disabled>
                                <small style="color: #666;">El usuario no se puede cambiar</small>
                            </div>
                            <div class="form-group">
                                <label>Nombre:</label>
                                <input type="text" id="editAsesorNombre" name="nombre" required>
                            </div>
                            <div class="form-group">
                                <label>Sede:</label>
                                <select id="editAsesorSede" name="sede" required>
                                    ${getSedes()
                    .map(
                        (sede) =>
                            `<option value="${sede}">${sede}</option>`,
                    )
                    .join("")}
                                </select>
                            </div>
                            <div class="form-group">
                                <button type="submit" class="btn">Guardar Cambios</button>
                            </div>
                        </form>
                    </div>
                </div>
            `;

            document.getElementById("app").innerHTML = html;
        }

        function crearAsesor(event) {
            event.preventDefault();
            const form = event.target;
            const formData = new FormData(form);

            const nuevoAsesor = {
                id: usuariosData.length + 1,
                username: formData.get("username"),
                password: formData.get("password"),
                nombre: formData.get("nombre"),
                rol: "asesor",
                sede: formData.get("sede"),
                foto: "",
            };

            usuariosData.push(nuevoAsesor);
            saveData();
            showAlert("Asesor creado exitosamente", "success");
            form.reset();

            // Re-renderizar para mostrar el nuevo asesor
            renderGestionAsesores();
        }

        function editarAsesor(id) {
            const asesor = usuariosData.find(
                (u) => u.id === id && u.rol === "asesor",
            );
            if (!asesor) return;

            document.getElementById("editAsesorId").value = asesor.id;
            document.getElementById("editAsesorUsername").value = asesor.username;
            document.getElementById("editAsesorNombre").value = asesor.nombre;
            document.getElementById("editAsesorSede").value = asesor.sede;

            document.getElementById("editAsesorModal").style.display = "flex";
        }

        function guardarAsesor(event) {
            event.preventDefault();
            const form = event.target;
            const id = parseInt(form.querySelector("#editAsesorId").value);
            const nombre = form.querySelector("#editAsesorNombre").value;
            const sede = form.querySelector("#editAsesorSede").value;

            const index = usuariosData.findIndex((u) => u.id === id);
            if (index !== -1) {
                usuariosData[index].nombre = nombre;
                usuariosData[index].sede = sede;
                saveData();
                showAlert("Asesor actualizado exitosamente", "success");
                cerrarModal();
                renderGestionAsesores();
            }
        }

        function eliminarAsesor(id) {
            if (confirm("쮼st치 seguro de eliminar este asesor?")) {
                usuariosData = usuariosData.filter(
                    (u) => !(u.id === id && u.rol === "asesor"),
                );
                saveData();
                showAlert("Asesor eliminado exitosamente", "success");
                renderGestionAsesores();
            }
        }

        function cerrarModal() {
            document.getElementById("editAsesorModal").style.display = "none";
        }

        // VISTA: Dashboard Asesor
        function renderDashboardAsesor() {
            if (!currentUser || currentUser.rol !== "asesor") {
                currentView = "login";
                localStorage.setItem("currentView", currentView);
                render();
                return;
            }

            const html = `
                <div class="dashboard-container">
                    <div class="sidebar">
                        <div class="user-info">
                            ${currentUser.foto
                    ? `<img src="${currentUser.foto}" alt="Foto perfil" class="profile-pic">`
                    : `<div class="profile-pic-placeholder">${currentUser.nombre.charAt(0)}</div>`
                }
                            <h3>${currentUser.nombre}</h3>
                            <p>Asesor - ${currentUser.sede}</p>
                        </div>
                        
                        <nav>
    <ul>
        <li><a href="#" onclick="navigate('ingresar_ventas')">俱 Ingresar Ventas</a></li>
        <li><a href="#" onclick="navigate('dashboard_asesor')" class="active">游늵 Dashboard</a></li>
        <li><a href="#" onclick="navigate('perfil')">游녻 Perfil</a></li>
        <li><a href="#" onclick="logout()">游뛁 Salir</a></li>
    </ul>
</nav>
                    </div>
                    
                    <div class="main-content">
                        <header>
                            <h1>Dashboard - ${currentUser.nombre}</h1>
                            <div style="color: #666;">
                                <span>Sede: ${currentUser.sede}</span>
                            </div>
                        </header>
                        
                        <div class="content">
                            ${alertMessage ? `<div class="alert alert-${alertType}">${alertMessage}</div>` : ""}
                            
                            <div style="margin-bottom: 20px;">
                                <select id="yearFilter" style="padding: 10px; margin-right: 10px;">
                                    <option value="">A침o</option>
                                </select>

                                <select id="monthFilter" style="padding: 10px;">
                                    <option value="">Mes</option>
                                    <option value="01">Enero</option>
                                    <option value="02">Febrero</option>
                                    <option value="03">Marzo</option>
                                    <option value="04">Abril</option>
                                    <option value="05">Mayo</option>
                                    <option value="06">Junio</option>
                                    <option value="07">Julio</option>
                                    <option value="08">Agosto</option>
                                    <option value="09">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                           
                            <div id="dashboardContent"></div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById("app").innerHTML = html;
            
            // Inicializar los filtros despu칠s de renderizar
            setTimeout(initializeDashboardFilters, 100);
        }
function renderIngresarVentas() {
    if (!currentUser || currentUser.rol !== "asesor") {
        currentView = "login";
        localStorage.setItem("currentView", currentView);
        render();
        return;
    }

    const html = `
        <div class="dashboard-container">
            <div class="sidebar">
                <div class="user-info">
                    ${currentUser.foto
                        ? `<img src="${currentUser.foto}" alt="Foto perfil" class="profile-pic">`
                        : `<div class="profile-pic-placeholder">${currentUser.nombre.charAt(0)}</div>`
                    }
                    <h3>${currentUser.nombre}</h3>
                    <p>Asesor - ${currentUser.sede}</p>
                </div>
                
                <nav>
                    <ul>
                        <li><a href="#" onclick="navigate('ingresar_ventas')" class="active">俱 Ingresar Ventas</a></li>
                        <li><a href="#" onclick="navigate('dashboard_asesor')">游늵 Dashboard</a></li>
                        <li><a href="#" onclick="navigate('perfil')">游녻 Perfil</a></li>
                        <li><a href="#" onclick="logout()">游뛁 Salir</a></li>
                    </ul>
                </nav>
            </div>
            
            <div class="main-content">
                <header>
                    <h1>俱 Ingresar Ventas/Clientes</h1>
                    <div style="color: #666;">
                        <span>Asesor: ${currentUser.nombre} - Sede: ${currentUser.sede}</span>
                    </div>
                </header>
                
                <div class="content">
                    ${alertMessage ? `<div class="alert alert-${alertType}">${alertMessage}</div>` : ""}
                    
                    <div class="card">
                        <h2>Seleccionar Per칤odo</h2>
                        <div style="display: flex; gap: 1rem; margin-bottom: 2rem; align-items: flex-end;">
                            <div class="form-group">
                                <label>A침o:</label>
                                <select id="ingresoYear" style="width: 200px;">
                                    ${[2025, 2026, 2027, 2028].map(year => 
                                        `<option value="${year}">${year}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <label>Mes:</label>
                                <select id="ingresoMonth" style="width: 200px;">
                                    ${Object.entries(getMeses()).map(([num, nombre]) => 
                                        `<option value="${num}">${nombre}</option>`
                                    ).join('')}
                                </select>
                            </div>
                            <div class="form-group">
                                <button class="btn" onclick="cargarFormularioIngreso()">Continuar</button>
                            </div>
                        </div>
                    </div>
                    
                    <div class="card" id="formularioIngresoContainer" style="display: none;">
                        <h2 id="tituloFormulario">Formulario de Ingreso</h2>
                        <form id="formularioIngreso" onsubmit="return guardarIngreso(event)">
                            <div class="form-grid">
                                <div class="form-group">
                                    <label>Tipo de Registro:</label>
                                    <select id="tipoRegistro" required onchange="mostrarCampoValor()">
                                        <option value="">Seleccionar</option>
                                        <option value="cliente">Solo Cliente</option>
                                        <option value="venta">Venta Realizada</option>
                                    </select>
                                </div>
                                
                                <div class="form-group" id="valorVehiculoContainer" style="display: none;">
                                    <label>Valor del Veh칤culo ($):</label>
                                    <input type="number" id="valorVehiculo" min="0" step="1000" placeholder="Ingrese valor en pesos">
                                </div>
                                
                                <div class="form-group">
                                    <label>Nombre del Cliente:</label>
                                    <input type="text" id="nombreCliente" required placeholder="Nombre completo">
                                </div>
                                
                                <div class="form-group">
                                    <label>C칠dula:</label>
                                    <input type="text" id="cedulaCliente" placeholder="N칰mero de c칠dula">
                                </div>
                                
                                <div class="form-group">
                                    <label>Celular:</label>
                                    <input type="text" id="celularCliente" required placeholder="N칰mero de celular">
                                </div>
                                
                                <div class="form-group">
                                    <label>Tipo de Veh칤culo:</label>
                                    <select id="tipoVehiculo" required>
                                        <option value="">Seleccionar</option>
                                        <option value="moto">Moto</option>
                                        <option value="patineta">Patineta</option>
                                        <option value="carro">Carro</option>
                                        <option value="bicicleta">Bicicleta</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Referencia:</label>
                                    <input type="text" id="referenciaVehiculo" required placeholder="Modelo o referencia">
                                </div>
                                
                                <div class="form-group">
                                    <label>Agencia:</label>
                                    <select id="agenciaVenta" required>
                                        <option value="">Seleccionar</option>
                                        <option value="Cra 33 Cabecera">Cra 33 Cabecera</option>
                                        <option value="Giron">Giron</option>
                                        <option value="Barrancabermeja">Barrancabermeja</option>
                                        <option value="La Concordia">La Concordia</option>
                                        <option value="Valledupar">Valledupar</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Fuente:</label>
                                    <select id="fuenteCliente" required>
                                        <option value="">Seleccionar</option>
                                        <option value="sala">Sala</option>
                                        <option value="digital">Digital</option>
                                        <option value="referido">Referido</option>
                                        <option value="playa">Playa</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Clasificaci칩n:</label>
                                    <select id="clasificacionCliente" required>
                                        <option value="">Seleccionar</option>
                                        <option value="exploracion">Exploraci칩n</option>
                                        <option value="evaluacion">Evaluaci칩n</option>
                                        <option value="decision">Decisi칩n</option>
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label>Tipo de Cliente:</label>
                                    <select id="tipoCliente" required>
                                        <option value="">Seleccionar</option>
                                        <option value="no-moto">Cliente no moto el칠ctrica</option>
                                        <option value="cm">Cliente ciudad movil</option>
                                        <option value="no-cm">Cliente de otra marca</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                                <button type="submit" class="btn btn-success">游 Guardar Registro</button>
                                <button type="button" class="btn btn-secondary" onclick="limpiarFormulario()">游딈勇 Limpiar Formulario</button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- NUEVA SECCI칍N AGREGADA: Tabla de registros recientes -->
                    <div class="card" style="margin-top: 2rem;">
                        <h2>游늶 Tus Registros Recientes</h2>
                        <div id="tablaRegistrosRecientes">
                            <!-- Aqu칤 se cargar치n los registros din치micamente -->
                            <p style="text-align: center; color: #666; padding: 2rem;">
                                Cargando tus registros...
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    document.getElementById("app").innerHTML = html;
    
    // Establecer a침o y mes actual por defecto
    const today = new Date();
    document.getElementById('ingresoYear').value = today.getFullYear();
    document.getElementById('ingresoMonth').value = String(today.getMonth() + 1).padStart(2, '0');
    
    // Cargar registros recientes
    setTimeout(() => {
        cargarRegistrosRecientes();
    }, 100);
}

function calcularVentasReales(mes, anio, asesor) {
    // Filtrar ventas del asesor en el mes/a침o espec칤fico
    const ventasAsesor = ventasData.filter(v => 
        v.asesor.toUpperCase() === asesor.toUpperCase() &&
        v.mes === parseInt(mes) &&
        v.anio === parseInt(anio)
    );
    
    // Calcular suma de valores
    let sumaValores = 0;
    ventasAsesor.forEach(venta => {
        sumaValores += venta.valor || 0;
    });
    
    return {
        cantidad: ventasAsesor.length,
        valorTotal: sumaValores
    };
}

function cargarFormularioIngreso() {
    const year = document.getElementById('ingresoYear').value;
    const month = document.getElementById('ingresoMonth').value;
    const monthName = getMeses()[parseInt(month)];
    
    document.getElementById('tituloFormulario').textContent = `Ingresar Datos - ${monthName} ${year}`;
    document.getElementById('formularioIngresoContainer').style.display = 'block';
    
    // Establecer la agencia seg칰n la sede del asesor actual
    document.getElementById('agenciaVenta').value = currentUser.sede;
}

// Funci칩n para mostrar/ocultar campo de valor
function mostrarCampoValor() {
    const tipoRegistro = document.getElementById('tipoRegistro').value;
    const valorContainer = document.getElementById('valorVehiculoContainer');
    
    if (tipoRegistro === 'venta') {
        valorContainer.style.display = 'block';
        document.getElementById('valorVehiculo').required = true;
    } else {
        valorContainer.style.display = 'none';
        document.getElementById('valorVehiculo').required = false;
    }
}

// Funci칩n para limpiar formulario
function limpiarFormulario() {
    document.getElementById('formularioIngreso').reset();
    document.getElementById('valorVehiculoContainer').style.display = 'none';
}

// Funci칩n para guardar el ingreso
function guardarIngreso(event) {
    event.preventDefault();
    
    const year = document.getElementById('ingresoYear').value;
    const month = document.getElementById('ingresoMonth').value;
    const tipoRegistro = document.getElementById('tipoRegistro').value;
    const nombreCliente = document.getElementById('nombreCliente').value;
    const cedulaCliente = document.getElementById('cedulaCliente').value;
    const celularCliente = document.getElementById('celularCliente').value;
    const tipoVehiculo = document.getElementById('tipoVehiculo').value;
    const referenciaVehiculo = document.getElementById('referenciaVehiculo').value;
    const agenciaVenta = document.getElementById('agenciaVenta').value;
    const fuenteCliente = document.getElementById('fuenteCliente').value;
    const clasificacionCliente = document.getElementById('clasificacionCliente').value;
    const tipoCliente = document.getElementById('tipoCliente').value;
    
    // Validar tipo de registro
    if (!tipoRegistro) {
        showAlert("Debe seleccionar si es Cliente o Venta", "error");
        return false;
    }
    
    // Validar valor de venta si es tipo venta
    let valorVenta = 0;
    if (tipoRegistro === 'venta') {
        valorVenta = parseInt(document.getElementById('valorVehiculo').value) || 0;
        
        if (valorVenta <= 0) {
            showAlert("Debe ingresar un valor v치lido para la venta", "error");
            return false;
        }
    }
    
    // Obtener fecha actual
    const today = new Date();
    const fecha = `${today.getDate().toString().padStart(2, '0')}/${(today.getMonth() + 1).toString().padStart(2, '0')}/${today.getFullYear()}`;
    
    // Crear objeto cliente
    const nuevoCliente = {
        id: clientesData.length > 0 ? Math.max(...clientesData.map(c => c.id)) + 1 : 1,
        asesor: currentUser.nombre.toUpperCase(),
        fecha: fecha,
        nombre: nombreCliente,
        cedula: cedulaCliente,
        celular: celularCliente,
        email: "",
        tipoCliente: tipoCliente,
        fuente: fuenteCliente,
        tipoVehiculo: tipoVehiculo,
        referencia: referenciaVehiculo,
        formaPago: tipoRegistro === 'venta' ? 'Venta realizada' : 'Prospecto',
        mes: parseInt(month),
        anio: parseInt(year),
        timestamp: new Date().toISOString()
    };
    
    // Agregar a base de datos de clientes
    clientesData.push(nuevoCliente);
    
    // Si es VENTA, tambi칠n agregar a ventas
    if (tipoRegistro === 'venta') {
        // Crear objeto venta con valor
        const nuevaVenta = {
            id: ventasData.length > 0 ? Math.max(...ventasData.map(v => v.id)) + 1 : 1,
            asesor: currentUser.nombre.toUpperCase(),
            cliente: nombreCliente,
            cedula: cedulaCliente,
            celular: celularCliente,
            tipo: tipoVehiculo,
            referencia: referenciaVehiculo,
            agencia: agenciaVenta,
            fuente: fuenteCliente,
            clasificacion: clasificacionCliente,
            tipoCliente: tipoCliente,
            valor: valorVenta,
            mes: parseInt(month),
            anio: parseInt(year),
            timestamp: new Date().toISOString()
        };
        
        // Agregar a base de datos de ventas
        ventasData.push(nuevaVenta);
    }
    
    // Guardar todos los datos (esto guarda en Firebase tambi칠n)
    saveData();
    
    // Mostrar mensaje de 칠xito
    const mensaje = tipoRegistro === 'venta' 
        ? `九 Venta registrada por $${valorVenta.toLocaleString()} - Se actualizar치 en el dashboard`
        : '九 Cliente registrado como prospecto - Se actualizar치 en el dashboard';
    
    showAlert(mensaje, "success");
    
    // Limpiar formulario
    limpiarFormulario();
    
    // Recargar la tabla de registros recientes
    setTimeout(() => {
        cargarRegistrosRecientes();
    }, 500);
    
    return false;
}
        // VISTA: Perfil
        function renderPerfil() {
            if (!currentUser) {
                currentView = "login";
                localStorage.setItem("currentView", currentView);
                render();
                return;
            }

            const html = `
                <div class="dashboard-container">
                    <div class="sidebar">
                        <div class="user-info">
                            ${currentUser.foto
                    ? `<img src="${currentUser.foto}" alt="Foto perfil" class="profile-pic" onclick="document.getElementById('fileInput').click()">`
                    : `<div class="profile-pic-placeholder" onclick="document.getElementById('fileInput').click()">${currentUser.nombre.charAt(0)}</div>`
                }
                            <h3>${currentUser.nombre}</h3>
                            <p>${currentUser.rol} - ${currentUser.sede}</p>
                        </div>
                        
                        <nav>
                            <ul>
                                <li><a href="#" onclick="navigate(currentUser.rol === 'gerente' ? 'dashboard_gerente' : 'dashboard_asesor')">游늵 Dashboard</a></li>
                                <li><a href="#" onclick="navigate('perfil')" class="active">游녻 Perfil</a></li>
                                <li><a href="#" onclick="logout()">游뛁 Salir</a></li>
                            </ul>
                        </nav>
                    </div>
                    
                    <div class="main-content">
                        <header>
                            <h1>Editar Perfil</h1>
                        </header>
                        
                        <div class="content">
                            ${alertMessage ? `<div class="alert alert-${alertType}">${alertMessage}</div>` : ""}
                            
                            <div class="card">
                                <h2>Informaci칩n Personal</h2>
                                <form id="profileForm" class="form-grid">
                                    <div class="form-group">
                                        <label>Usuario:</label>
                                        <input type="text" value="${currentUser.username}" disabled>
                                        <small style="color: #666;">El usuario no se puede cambiar</small>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Nombre:</label>
                                        <input type="text" id="profileNombre" value="${currentUser.nombre}" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Sede:</label>
                                        <select id="profileSede" required>
                                            ${getSedes()
                    .map(
                        (sede) => `
                                                <option value="${sede}" ${sede === currentUser.sede ? "selected" : ""}>${sede}</option>
                                            `,
                    )
                    .join("")}
                                        </select>
                                    </div>
                                    
                                    <div class="form-group">
                                        <button type="button" class="btn" onclick="actualizarPerfil()">Actualizar Perfil</button>
                                    </div>
                                </form>
                                
                                <div style="margin-top: 1rem;">
                                    <input type="file" id="fileInput" style="display: none;" accept="image/*" onchange="cargarFotoPerfil(event)">
                                    <label for="fileInput" class="btn btn-success">游닝 Cambiar Foto de Perfil</label>
                                    <small style="display: block; margin-top: 0.5rem; color: #666;">
                                        Formatos permitidos: JPG, PNG, GIF, WEBP (M치x. 5MB)
                                    </small>
                                </div>
                            </div>
                            
                            <div class="card">
                                <h2>Cambiar Contrase침a</h2>
                                <form id="passwordForm" class="form-grid">
                                    <div class="form-group">
                                        <label>Contrase침a Actual:</label>
                                        <input type="password" id="currentPassword" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Nueva Contrase침a:</label>
                                        <input type="password" id="newPassword" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <label>Confirmar Nueva Contrase침a:</label>
                                        <input type="password" id="confirmPassword" required>
                                    </div>
                                    
                                    <div class="form-group">
                                        <button type="button" class="btn" onclick="cambiarContrase침a()">Cambiar Contrase침a</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById("app").innerHTML = html;
        }

        function actualizarPerfil() {
            const nombre = document.getElementById("profileNombre").value;
            const sede = document.getElementById("profileSede").value;

            // Actualizar en currentUser
            currentUser.nombre = nombre;
            currentUser.sede = sede;

            // Actualizar en usuariosData
            const userIndex = usuariosData.findIndex(
                (u) => u.id === currentUser.id,
            );
            if (userIndex !== -1) {
                usuariosData[userIndex].nombre = nombre;
                usuariosData[userIndex].sede = sede;
            }

            // Guardar cambios
            localStorage.setItem("currentUser", JSON.stringify(currentUser));
            saveData();

            showAlert("Perfil actualizado exitosamente", "success");

            // Re-renderizar para actualizar la informaci칩n
            renderPerfil();
        }

        function cargarFotoPerfil(event) {
            const file = event.target.files[0];
            if (!file) return;

            // Validar tama침o (5MB m치ximo)
            if (file.size > 5 * 1024 * 1024) {
                showAlert("La imagen es demasiado grande (m치x. 5MB)", "error");
                return;
            }

            // Validar tipo
            const validTypes = [
                "image/jpeg",
                "image/png",
                "image/gif",
                "image/webp",
            ];
            if (!validTypes.includes(file.type)) {
                showAlert("Formato de imagen no v치lido", "error");
                return;
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                // Guardar en currentUser
                currentUser.foto = e.target.result;

                // Guardar en usuariosData
                const userIndex = usuariosData.findIndex(
                    (u) => u.id === currentUser.id,
                );
                if (userIndex !== -1) {
                    usuariosData[userIndex].foto = e.target.result;
                }

                // Guardar cambios
                localStorage.setItem("currentUser", JSON.stringify(currentUser));
                saveData();

                showAlert("Foto de perfil actualizada exitosamente", "success");

                // Re-renderizar para mostrar la nueva foto
                renderPerfil();
            };
            reader.readAsDataURL(file);
        }

        function cambiarContrase침a() {
            const currentPassword =
                document.getElementById("currentPassword").value;
            const newPassword = document.getElementById("newPassword").value;
            const confirmPassword =
                document.getElementById("confirmPassword").value;

            // Validar que las contrase침as nuevas coincidan
            if (newPassword !== confirmPassword) {
                showAlert("Las contrase침as nuevas no coinciden", "error");
                return;
            }

            // Validar contrase침a actual
            const usuario = usuariosData.find((u) => u.id === currentUser.id);
            if (!usuario || usuario.password !== currentPassword) {
                showAlert("La contrase침a actual es incorrecta", "error");
                return;
            }

            // Actualizar contrase침a
            usuario.password = newPassword;
            saveData();

            // Limpiar formulario
            document.getElementById("currentPassword").value = "";
            document.getElementById("newPassword").value = "";
            document.getElementById("confirmPassword").value = "";

            showAlert("Contrase침a cambiada exitosamente", "success");
        }

        // ==================== FUNCIONES GLOBALES ====================

        function navigate(view) {
            currentView = view;
            currentPage = 1; // Resetear paginaci칩n al cambiar de vista
            // Guardar vista actual en localStorage
            localStorage.setItem("currentView", currentView);
            render();
        }

        function changePage(page) {
            currentPage = page;
            render();
            // Scroll to top
            window.scrollTo(0, 0);
        }

        function logout() {
            currentUser = null;
            currentView = "login";
            localStorage.removeItem("currentUser");
            localStorage.removeItem("currentView");
            render();
            showAlert("Sesi칩n cerrada exitosamente", "success");
        }

        // ==================== FUNCIONES DEL DASHBOARD ====================

        function initializeDashboardFilters() {
            const yearSelect = document.getElementById('yearFilter');
            const monthSelect = document.getElementById('monthFilter');
            const dashboardContent = document.getElementById('dashboardContent');

            if (!yearSelect || !monthSelect || !dashboardContent) return;

            // Limpiar opciones existentes
            yearSelect.innerHTML = '<option value="">A침o</option>';
            
            // A침os desde 2025 hasta 2036
            for (let year = 2025; year <= 2036; year++) {
                yearSelect.innerHTML += `<option value="${year}">${year}</option>`;
            }

            // Establecer 2026 como a침o por defecto
            yearSelect.value = "2026";
            
            // Cargar mes actual como por defecto
            const currentMonth = new Date().getMonth() + 1;
            monthSelect.value = currentMonth.toString().padStart(2, '0');

            yearSelect.addEventListener('change', loadDashboard);
            monthSelect.addEventListener('change', loadDashboard);

            // Cargar dashboard inicial
            loadDashboard();
        }

function loadDashboard() {
    const yearSelect = document.getElementById('yearFilter');
    const monthSelect = document.getElementById('monthFilter');
    const dashboardContent = document.getElementById('dashboardContent');

    if (!yearSelect || !monthSelect || !dashboardContent) return;

    const year = yearSelect.value;
    const month = monthSelect.value;

    if (!year || !month) return;

    const monthsMap = {
        '01': 'Enero',
        '02': 'Febrero',
        '03': 'Marzo',
        '04': 'Abril',
        '05': 'Mayo',
        '06': 'Junio',
        '07': 'Julio',
        '08': 'Agosto',
        '09': 'Septiembre',
        '10': 'Octubre',
        '11': 'Noviembre',
        '12': 'Diciembre'
    };

    const monthName = monthsMap[month];
    
    // Solo Enero 2026 carga el iframe
    if (year === "2026" && month === "01") {
        const fileName = `${monthName}${year.slice(2)}.html`;
        dashboardContent.innerHTML = `
            <iframe
                id="dashboardFrame"
                src="Content/${year}/${fileName}"
                style="width:100%; border:none; min-height:800px;"
            ></iframe>
        `;
    } else {
        // Para todos los otros meses y a침os, mostrar el dashboard embebido
        dashboardContent.innerHTML = generarDashboardHTML(monthName, year);
        
        // Ahora ejecutar el JavaScript del dashboard PASANDO LOS PAR츼METROS
        setTimeout(() => {
            initializeDashboardScripts(monthName, parseInt(year));
        }, 100);
    }
}

// Nueva funci칩n para inicializar los scripts del dashboard
function initializeDashboardScripts(mes, anio) {
    // ========================================================
    // DATOS COMPLETOS DE VENTAS - Filtrar por mes y a침o seleccionados
    // ========================================================
    
    // Mapeo de meses
    const monthsMap = {
        '01': 'Enero', '02': 'Febrero', '03': 'Marzo', '04': 'Abril',
        '05': 'Mayo', '06': 'Junio', '07': 'Julio', '08': 'Agosto',
        '09': 'Septiembre', '10': 'Octubre', '11': 'Noviembre', '12': 'Diciembre'
    };
    
    const mesesMap = {
        'Enero': '01', 'Febrero': '02', 'Marzo': '03', 'Abril': '04',
        'Mayo': '05', 'Junio': '06', 'Julio': '07', 'Agosto': '08',
        'Septiembre': '09', 'Octubre': '10', 'Noviembre': '11', 'Diciembre': '12'
    };
    
    // Convertir nombre del mes a n칰mero
    const mesNumero = mesesMap[mes] || '01';
    const anioNumero = parseInt(anio);
    
    // Filtrar ventas por mes y a침o seleccionados
    const e_ventas = ventasData.filter(venta => {
        return venta.mes === parseInt(mesNumero) && venta.anio === anioNumero;
    });

    // Filtrar clientes por mes y a침o seleccionados
    const e_clientes = clientesData.filter(cliente => {
        return cliente.mes === parseInt(mesNumero) && cliente.anio === anioNumero;
    });

    // ========================================================
    // Mapeo de asesores a sus sedes
    // ========================================================
    const e_asesorSedeMap = {
        "YOLANDA": "Cra 33 Cabecera",
        "FABIOLA": "Cra 33 Cabecera",
        "LINA": "Giron",
        "ADRIANA": "Barrancabermeja",
        "SANDRA": "La Concordia",
        "DINA LUZ": "Valledupar"
    };

    // Mapeo de sedes a sus asesores
    const e_sedeAsesorMap = {
        "Cra 33 Cabecera": ["YOLANDA", "FABIOLA"],
        "La Concordia": ["SANDRA"],
        "Giron": ["LINA"],
        "Barrancabermeja": ["ADRIANA"],
        "Valledupar": ["DINA LUZ"]
    };

    // Funci칩n para obtener todas las referencias 칰nicas
    function e_obtenerReferencias() {
        const referenciasSet = new Set();
        e_ventas.forEach(venta => {
            if (venta.referencia && venta.referencia.trim() !== "") {
                referenciasSet.add(venta.referencia.toUpperCase());
            }
        });
        return Array.from(referenciasSet).sort();
    }

    // Funci칩n para actualizar las opciones de referencia seg칰n el tipo de veh칤culo
    function e_actualizarReferencias(tipo) {
        const filtroReferencia = document.getElementById('e-filtro-referencia');
        if (!filtroReferencia) return;
        
        filtroReferencia.innerHTML = '<option value="all">Todas</option>';
        
        if (tipo === 'all') {
            const todasReferencias = e_obtenerReferencias();
            todasReferencias.forEach(ref => {
                filtroReferencia.innerHTML += `<option value="${ref}">${ref}</option>`;
            });
        } else {
            const referenciasFiltradas = new Set();
            e_ventas.forEach(venta => {
                if (venta.tipo === tipo && venta.referencia && venta.referencia.trim() !== "") {
                    referenciasFiltradas.add(venta.referencia.toUpperCase());
                }
            });
            
            Array.from(referenciasFiltradas).sort().forEach(ref => {
                filtroReferencia.innerHTML += `<option value="${ref}">${ref}</option>`;
            });
        }
    }

    // Funci칩n para mostrar estad칤sticas del asesor con filtros aplicados
    function e_mostrarEstadisticasAsesor(asesor, filtroTipo = 'all', filtroReferencia = 'all') {
        // Obtener nombre del asesor para mostrar
        const nombresAsesores = {
            "YOLANDA": "Yolanda",
            "SANDRA": "Sandra",
            "LINA": "Lina",
            "FABIOLA": "Fabiola",
            "ADRIANA": "Adriana",
            "DINA LUZ": "Dina Luz"
        };
        
        // Filtrar ventas del asesor
        let ventasAsesor = e_ventas.filter(v => v.asesor.toUpperCase() === asesor.toUpperCase());
        
        // Aplicar filtros adicionales si existen
        if (filtroTipo !== 'all') {
            ventasAsesor = ventasAsesor.filter(v => v.tipo === filtroTipo);
        }
        
        if (filtroReferencia !== 'all') {
            ventasAsesor = ventasAsesor.filter(v => v.referencia.toUpperCase() === filtroReferencia.toUpperCase());
        }
        
        // Calcular estad칤sticas
        let motos = 0, patinetas = 0, carros = 0, bicicletas = 0;
        let sala = 0, digital = 0, referido = 0, playa = 0;
        let exploracion = 0, evaluacion = 0, decision = 0;
        const referenciasCount = {};
        
        ventasAsesor.forEach(venta => {
            // Tipo de veh칤culo
            if (venta.tipo === 'moto') motos++;
            else if (venta.tipo === 'patineta') patinetas++;
            else if (venta.tipo === 'carro') carros++;
            else if (venta.tipo === 'bicicleta') bicicletas++;
            
            // Fuente
            if (venta.fuente === 'sala') sala++;
            else if (venta.fuente === 'digital') digital++;
            else if (venta.fuente === 'referido') referido++;
            else if (venta.fuente === 'playa') playa++;
            
            // Clasificaci칩n
            if (venta.clasificacion === 'exploracion') exploracion++;
            else if (venta.clasificacion === 'evaluacion') evaluacion++;
            else if (venta.clasificacion === 'decision') decision++;
            
            // Referencias
            const ref = venta.referencia || 'Sin referencia';
            referenciasCount[ref] = (referenciasCount[ref] || 0) + 1;
        });
        
        // Actualizar el t칤tulo
        const nombreAsesorElement = document.getElementById('e-nombreAsesorEstadisticas');
        if (nombreAsesorElement) {
            nombreAsesorElement.textContent = `Estad칤sticas de ${nombresAsesores[asesor] || asesor}`;
        }
        
        // Actualizar los valores
        const updateElement = (id, value) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        };
        
        updateElement('e-estMotos', motos);
        updateElement('e-estPatinetas', patinetas);
        updateElement('e-estCarros', carros);
        updateElement('e-estBicicletas', bicicletas);
        
        updateElement('e-estSala', sala);
        updateElement('e-estDigital', digital);
        updateElement('e-estReferido', referido);
        updateElement('e-estPlaya', playa);
        
        updateElement('e-estExploracion', exploracion);
        updateElement('e-estEvaluacion', evaluacion);
        updateElement('e-estDecision', decision);
        
        // Crear gr치fico de barras para referencias
        const graficoContainer = document.getElementById('e-graficoReferencias');
        if (graficoContainer) {
            graficoContainer.innerHTML = '';
            
            // Ordenar referencias por cantidad (de mayor a menor)
            const referenciasOrdenadas = Object.entries(referenciasCount)
                .sort((a, b) => b[1] - a[1]);
            
            // Encontrar el m치ximo para calcular porcentajes
            const maxReferencias = referenciasOrdenadas.length > 0 ? Math.max(...referenciasOrdenadas.map(r => r[1])) : 1;
            
            referenciasOrdenadas.forEach(([referencia, cantidad]) => {
                const porcentaje = (cantidad / maxReferencias) * 100;
                
                const barraItem = document.createElement('div');
                barraItem.className = 'e-barra-item';
                
                // Determinar clase de color seg칰n el tipo de veh칤culo predominante
                let barraClass = 'e-barra-moto';
                
                // Buscar el tipo de veh칤culo para esta referencia
                const ventaRef = ventasAsesor.find(v => v.referencia === referencia);
                if (ventaRef) {
                    if (ventaRef.tipo === 'moto') barraClass = 'e-barra-moto';
                    else if (ventaRef.tipo === 'patineta') barraClass = 'e-barra-patineta';
                    else if (ventaRef.tipo === 'carro') barraClass = 'e-barra-carro';
                    else if (ventaRef.tipo === 'bicicleta') barraClass = 'e-barra-bicicleta';
                }
                
                barraItem.innerHTML = `
                    <div class="e-barra-label">
                        <span>${referencia}</span>
                        <span>${cantidad} venta(s)</span>
                    </div>
                    <div class="e-barra-progreso">
                        <div class="e-barra-progreso-fill ${barraClass}" style="width: ${porcentaje}%">
                            ${cantidad}
                        </div>
                    </div>
                `;
                
                graficoContainer.appendChild(barraItem);
            });
        }
        
        // Mostrar el contenedor de estad칤sticas
        const estadisticasContainer = document.getElementById('e-estadisticasAsesor');
        if (estadisticasContainer) {
            estadisticasContainer.classList.add('active');
        }
    }

    // Funci칩n para actualizar m칠tricas principales
    function e_actualizarMetricas() {
        // Calcular m칠tricas
        const asesoresUnicos = new Set(e_ventas.map(v => v.asesor));
        const sedesUnicas = new Set(e_ventas.map(v => v.agencia));
        
        const updateMetrica = (id, value) => {
            const element = document.getElementById(id);
            if (element) element.textContent = value;
        };
        
        updateMetrica('e-metricaAsesores', asesoresUnicos.size);
        updateMetrica('e-metricaSucursales', sedesUnicas.size);
        updateMetrica('e-metricaVentas', e_ventas.length);
        updateMetrica('e-metricaClientes', e_clientes.length);
    }

    // Funci칩n para actualizar tabla de ventas y prospectos
// En la funci칩n e_actualizarTablaVentasProspectos(), reemplaza la parte donde obtienes los valores:
function e_actualizarTablaVentasProspectos() {
    const tbody = document.getElementById('e-tablaVentasProspectosBody');
    if (!tbody) return;
    
    tbody.innerHTML = '';
    
    const asesores = [
        { id: "DINA LUZ", nombre: "Dina Luz" },
        { id: "FABIOLA", nombre: "Fabiola" },
        { id: "YOLANDA", nombre: "Yolanda" },
        { id: "LINA", nombre: "Lina" },
        { id: "ADRIANA", nombre: "Adriana" },
        { id: "SANDRA", nombre: "Sandra" }
    ];
    
    let totalPptoVentas = 0;
    let totalRealVentas = 0;
    let totalPptoEfectividad = 0;
    let totalRealEfectividad = 0;
    let totalPptoProspectos = 0;
    let totalRealProspectos = 0;
    
    const mesNumeroStr = mesNumero;
    const anioNumero = parseInt(anio);
    
    asesores.forEach(asesor => {
        // 1. PPTO ($) - Ventas en pesos (EDITABLE por gerente)
        const pptoVentas = getPresupuestoVentas(mesNumeroStr, anioNumero, asesor.id) || 0;
        
        // 2. Real ($) - CALCULAR de ventas REALES del asesor
        const ventasReales = calcularVentasReales(mesNumeroStr, anioNumero, asesor.id);
        const realVentas = ventasReales.valorTotal; // Suma de valores de ventas
        
        // 3. PPTO - Efectividad (EDITABLE por gerente)
        const pptoEfectividad = getPresupuestoEfectividad(mesNumeroStr, anioNumero, asesor.id) || 0;
        
        // 4. Real - Cantidad de ventas REALES
        const realEfectividad = ventasReales.cantidad; // Cantidad de ventas
        
        // 5. PPTO - Prospectos (EDITABLE por gerente)
        const pptoProspectos = getPresupuestoProspectos(mesNumeroStr, anioNumero, asesor.id) || 0;
        
        // 6. Real - Prospectos (Suma de CLIENTES + VENTAS = todas las atenciones)
        const clientesAsesor = clientesData.filter(c => 
            c.asesor.toUpperCase() === asesor.id.toUpperCase() &&
            c.mes === parseInt(mesNumeroStr) &&
            c.anio === anioNumero
        );
        
        const ventasAsesor = ventasData.filter(v => 
            v.asesor.toUpperCase() === asesor.id.toUpperCase() &&
            v.mes === parseInt(mesNumeroStr) &&
            v.anio === anioNumero
        );
        
        // Sumar clientes + ventas para obtener el total de atenciones
        const realProspectos = clientesAsesor.length + ventasAsesor.length;
        
        // 7. Calcular PRIMER %: Real ($) 칭 PPTO ($) 칑 100
        const porcentajeVentas = pptoVentas > 0 ? Math.round((realVentas / pptoVentas) * 100) : 0;
        
        // 8. Calcular SEGUNDO %: Real (efectividad) 칭 PPTO (efectividad) 칑 100
        const porcentajeEfectividad = pptoEfectividad > 0 ? Math.round((realEfectividad / pptoEfectividad) * 100) : 0;
        
        // 9. Calcular TERCER %: Real (prospectos) 칭 PPTO (prospectos) 칑 100
        const porcentajeProspectos = pptoProspectos > 0 ? Math.round((realProspectos / pptoProspectos) * 100) : 0;
        
        // Determinar clase de porcentaje
        const getPorcentajeClass = (porcentaje) => {
            if (porcentaje >= 100) return 'e-porcentaje-bueno';
            if (porcentaje >= 50) return 'e-porcentaje-medio';
            return 'e-porcentaje-bajo';
        };
        
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${asesor.nombre}</td>
            <td class="e-columna-ventas">$ ${pptoVentas.toLocaleString()}</td>
            <td class="e-columna-ventas">$ ${realVentas.toLocaleString()}</td>
            <td class="e-columna-ventas">${pptoEfectividad.toLocaleString()}</td>
            <td class="e-columna-ventas">${realEfectividad.toLocaleString()}</td>
            <td class="e-columna-ventas ${getPorcentajeClass(porcentajeVentas)}">${porcentajeVentas}%</td>
            <td class="e-columna-prospectos">${pptoProspectos.toLocaleString()}</td>
            <td class="e-columna-prospectos">${realProspectos.toLocaleString()}</td>
            <td class="e-columna-prospectos ${getPorcentajeClass(porcentajeProspectos)}">${porcentajeProspectos}%</td>
        `;
        
        tbody.appendChild(row);
        
        // Acumular totales
        totalPptoVentas += pptoVentas;
        totalRealVentas += realVentas;
        totalPptoEfectividad += pptoEfectividad;
        totalRealEfectividad += realEfectividad;
        totalPptoProspectos += pptoProspectos;
        totalRealProspectos += realProspectos;
    });
    
    // Calcular porcentajes totales
    const totalPorcentajeVentas = totalPptoVentas > 0 ? Math.round((totalRealVentas / totalPptoVentas) * 100) : 0;
    const totalPorcentajeEfectividad = totalPptoEfectividad > 0 ? Math.round((totalRealEfectividad / totalPptoEfectividad) * 100) : 0;
    const totalPorcentajeProspectos = totalPptoProspectos > 0 ? Math.round((totalRealProspectos / totalPptoProspectos) * 100) : 0;
    
    const totalRow = document.createElement('tr');
    totalRow.className = 'e-total-row';
    totalRow.innerHTML = `
        <td><strong>TOTAL</strong></td>
        <td class="e-columna-ventas"><strong>$ ${totalPptoVentas.toLocaleString()}</strong></td>
        <td class="e-columna-ventas"><strong>$ ${totalRealVentas.toLocaleString()}</strong></td>
        <td class="e-columna-ventas"><strong>${totalPptoEfectividad.toLocaleString()}</strong></td>
        <td class="e-columna-ventas"><strong>${totalRealEfectividad.toLocaleString()}</strong></td>
        <td class="e-columna-ventas"><strong>${totalPorcentajeVentas}%</strong></td>
        <td class="e-columna-prospectos"><strong>${totalPptoProspectos.toLocaleString()}</strong></td>
        <td class="e-columna-prospectos"><strong>${totalRealProspectos.toLocaleString()}</strong></td>
        <td class="e-columna-prospectos"><strong>${totalPorcentajeProspectos}%</strong></td>
    `;
    
    tbody.appendChild(totalRow);
}
    // Funci칩n para actualizar estad칤sticas
    function e_actualizarEstadisticas() {
        // Calcular estad칤sticas por tipo de veh칤culo
        const tipoVehiculoStats = {};
        e_ventas.forEach(venta => {
            const tipo = venta.tipo || 'desconocido';
            tipoVehiculoStats[tipo] = (tipoVehiculoStats[tipo] || 0) + 1;
        });
        
        // Actualizar tabla de tipo de veh칤culo
        const tablaTipoVehiculo = document.getElementById('e-tablaTipoVehiculo');
        if (tablaTipoVehiculo) {
            const tbody = tablaTipoVehiculo.querySelector('tbody');
            if (tbody) {
                tbody.innerHTML = '';
                
                const tipos = ['moto', 'patineta', 'carro', 'bicicleta'];
                let total = 0;
                
                tipos.forEach(tipo => {
                    const cantidad = tipoVehiculoStats[tipo] || 0;
                    total += cantidad;
                    
                    const row = document.createElement('tr');
                    const icon = tipo === 'moto' ? 'fa-motorcycle' : 
                                tipo === 'patineta' ? 'fa-scooter' : 
                                tipo === 'carro' ? 'fa-car' : 'fa-bicycle';
                    row.innerHTML = `
                        <td><i class="fas ${icon}"></i> ${tipo.charAt(0).toUpperCase() + tipo.slice(1)}</td>
                        <td>${cantidad}</td>
                        <td>${e_ventas.length > 0 ? Math.round((cantidad / e_ventas.length) * 100) : 0}%</td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Fila total
                const totalRow = document.createElement('tr');
                totalRow.className = 'e-total-row';
                totalRow.innerHTML = `
                    <td><strong>TOTAL</strong></td>
                    <td><strong>${total}</strong></td>
                    <td><strong>100%</strong></td>
                `;
                tbody.appendChild(totalRow);
            }
        }
        
        // Calcular estad칤sticas por fuente de clientes
        const fuenteStats = {};
        e_ventas.forEach(venta => {
            const fuente = venta.fuente || 'desconocido';
            fuenteStats[fuente] = (fuenteStats[fuente] || 0) + 1;
        });
        
        // Actualizar tabla de fuentes de clientes
        const tablaFuentes = document.getElementById('e-tablaFuentesClientes');
        if (tablaFuentes) {
            const tbody = tablaFuentes.querySelector('tbody');
            if (tbody) {
                tbody.innerHTML = '';
                
                const fuentes = ['sala', 'digital', 'referido', 'playa'];
                let total = 0;
                
                fuentes.forEach(fuente => {
                    const cantidad = fuenteStats[fuente] || 0;
                    total += cantidad;
                    
                    const row = document.createElement('tr');
                    const icon = fuente === 'sala' ? 'fa-store-alt' : 
                                fuente === 'digital' ? 'fa-desktop' : 
                                fuente === 'referido' ? 'fa-user-friends' : 'fa-store';
                    const nombre = fuente === 'sala' ? 'Sala' : 
                                 fuente === 'digital' ? 'Digital' : 
                                 fuente === 'referido' ? 'Referido' : 'Playa';
                    row.innerHTML = `
                        <td><i class="fas ${icon}"></i> ${nombre}</td>
                        <td>${cantidad}</td>
                        <td>${e_ventas.length > 0 ? Math.round((cantidad / e_ventas.length) * 100) : 0}%</td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Fila total
                const totalRow = document.createElement('tr');
                totalRow.className = 'e-total-row';
                totalRow.innerHTML = `
                    <td><strong>TOTAL</strong></td>
                    <td><strong>${total}</strong></td>
                    <td><strong>100%</strong></td>
                `;
                tbody.appendChild(totalRow);
            }
        }
        
        // Calcular estad칤sticas por clasificaci칩n de clientes
        const clasificacionStats = {};
        e_ventas.forEach(venta => {
            const clasificacion = venta.clasificacion || 'desconocido';
            clasificacionStats[clasificacion] = (clasificacionStats[clasificacion] || 0) + 1;
        });
        
        // Actualizar tabla de clasificaci칩n de clientes
        const tablaClasificacion = document.getElementById('e-tablaClasificacionClientes');
        if (tablaClasificacion) {
            const tbody = tablaClasificacion.querySelector('tbody');
            if (tbody) {
                tbody.innerHTML = '';
                
                const clasificaciones = ['exploracion', 'evaluacion', 'decision'];
                let total = 0;
                
                clasificaciones.forEach(clasificacion => {
                    const cantidad = clasificacionStats[clasificacion] || 0;
                    total += cantidad;
                    
                    const row = document.createElement('tr');
                    const icon = clasificacion === 'exploracion' ? 'fa-search' : 
                                clasificacion === 'evaluacion' ? 'fa-clipboard-check' : 'fa-check-circle';
                    const nombre = clasificacion === 'exploracion' ? 'Exploraci칩n' : 
                                 clasificacion === 'evaluacion' ? 'Evaluaci칩n' : 'Decisi칩n';
                    row.innerHTML = `
                        <td><i class="fas ${icon}"></i> ${nombre}</td>
                        <td>${cantidad}</td>
                        <td>${e_ventas.length > 0 ? Math.round((cantidad / e_ventas.length) * 100) : 0}%</td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Fila total
                const totalRow = document.createElement('tr');
                totalRow.className = 'e-total-row';
                totalRow.innerHTML = `
                    <td><strong>TOTAL</strong></td>
                    <td><strong>${total}</strong></td>
                    <td><strong>100%</strong></td>
                `;
                tbody.appendChild(totalRow);
            }
        }
        
        // Calcular estad칤sticas por tipo de cliente
        const tipoClienteStats = {};
        e_ventas.forEach(venta => {
            const tipoCliente = venta.tipoCliente || 'desconocido';
            tipoClienteStats[tipoCliente] = (tipoClienteStats[tipoCliente] || 0) + 1;
        });
        
        // Actualizar tabla de tipo de cliente
        const tablaTipoCliente = document.getElementById('e-tablaTipoCliente');
        if (tablaTipoCliente) {
            const tbody = tablaTipoCliente.querySelector('tbody');
            if (tbody) {
                tbody.innerHTML = '';
                
                const tiposCliente = ['no-moto', 'cm', 'no-cm'];
                let total = 0;
                
                tiposCliente.forEach(tipo => {
                    const cantidad = tipoClienteStats[tipo] || 0;
                    total += cantidad;
                    
                    const row = document.createElement('tr');
                    const icon = tipo === 'no-moto' ? 'fa-motorcycle' : 
                                tipo === 'cm' ? 'fa-city' : 'fa-user-plus';
                    const nombre = tipo === 'no-moto' ? 'Cliente no moto el칠ctrica' : 
                                 tipo === 'cm' ? 'Cliente ciudad movil' : 'Cliente de otra marca';
                    row.innerHTML = `
                        <td><i class="fas ${icon}"></i> ${nombre}</td>
                        <td>${cantidad}</td>
                        <td>${e_ventas.length > 0 ? Math.round((cantidad / e_ventas.length) * 100) : 0}%</td>
                    `;
                    tbody.appendChild(row);
                });
                
                // Fila total
                const totalRow = document.createElement('tr');
                totalRow.className = 'e-total-row';
                totalRow.innerHTML = `
                    <td><strong>TOTAL</strong></td>
                    <td><strong>${total}</strong></td>
                    <td><strong>100%</strong></td>
                `;
                tbody.appendChild(totalRow);
            }
        }
    }

    // Funci칩n para actualizar sedes
    function e_actualizarSedes() {
        const sedesContainer = document.getElementById('e-sedesContainer');
        if (!sedesContainer) return;
        
        sedesContainer.innerHTML = '';
        
        const sedes = [
            { nombre: "Cra 33 Cabecera", asesores: ["Yolanda", "Fabiola"] },
            { nombre: "Giron", asesores: ["Lina"] },
            { nombre: "Barrancabermeja", asesores: ["Adriana"] },
            { nombre: "La Concordia", asesores: ["Sandra"] },
            { nombre: "Valledupar", asesores: ["Dina Luz"] }
        ];
        
        sedes.forEach(sede => {
            // Calcular estad칤sticas de la sede
            const ventasSede = e_ventas.filter(v => {
                const agencia = v.agencia || '';
                return agencia.toLowerCase().includes(sede.nombre.toLowerCase());
            });
            
            const clientesSede = e_clientes.filter(c => {
                const asesor = c.asesor || '';
                return sede.asesores.some(a => asesor.toLowerCase().includes(a.toLowerCase()));
            });
            
            const efectividad = ventasSede.length;
            const prospectos = clientesSede.length;
            const porcentajeEfectividad = prospectos > 0 ? Math.round((efectividad / prospectos) * 100) : 0;
            
            const sedeCard = document.createElement('div');
            sedeCard.className = 'e-sede-card';
            sedeCard.innerHTML = `
                <h3><i class="fas fa-store"></i> ${sede.nombre}</h3>
                <div class="e-sede-info">
                    <div class="e-info-item">
                        <span>Asesores:</span>
                        <span class="e-valor">${sede.asesores.join(', ')}</span>
                    </div>
                    <div class="e-info-item">
                        <span>Efectividad:</span>
                        <span class="e-valor">${efectividad}</span>
                    </div>
                    <div class="e-info-item">
                        <span>Prospectos:</span>
                        <span class="e-valor">${prospectos}</span>
                    </div>
                    <div class="e-info-item">
                        <span>% Efectividad:</span>
                        <span class="e-valor">${porcentajeEfectividad}%</span>
                    </div>
                </div>
            `;
            
            sedesContainer.appendChild(sedeCard);
        });
    }

    // Funci칩n para renderizar tabla de ventas detallada
    function e_renderizarTablaVentas(filtroAsesor = 'all', filtroSede = 'all', filtroTipo = 'all', filtroReferencia = 'all') {
        const tbody = document.getElementById('e-tablaVentasDetalleBody');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        let contador = 0;
        
        e_ventas.forEach(venta => {
            // Aplicar filtros
            if (filtroAsesor !== 'all' && venta.asesor.toUpperCase() !== filtroAsesor.toUpperCase()) return;
            if (filtroSede !== 'all') {
                const agencia = venta.agencia || '';
                if (!agencia.toLowerCase().includes(filtroSede.toLowerCase())) return;
            }
            if (filtroTipo !== 'all' && venta.tipo !== filtroTipo) return;
            if (filtroReferencia !== 'all' && venta.referencia.toUpperCase() !== filtroReferencia.toUpperCase()) return;
            
            contador++;
            
            // Determinar clases para badges
            let tipoBadgeClass = '';
            if (venta.tipo === 'moto') tipoBadgeClass = 'e-moto-badge';
            else if (venta.tipo === 'patineta') tipoBadgeClass = 'e-patineta-badge';
            else if (venta.tipo === 'carro') tipoBadgeClass = 'e-carro-badge';
            else if (venta.tipo === 'bicicleta') tipoBadgeClass = 'e-bicicleta-badge';
            
            let fuenteBadgeClass = '';
            if (venta.fuente === 'digital') fuenteBadgeClass = 'e-digital-badge';
            else if (venta.fuente === 'referido') fuenteBadgeClass = 'e-referido-badge';
            else if (venta.fuente === 'playa') fuenteBadgeClass = 'e-playa-badge';
            else if (venta.fuente === 'sala') fuenteBadgeClass = 'e-sala-badge';
            
            let clasificacionBadgeClass = '';
            if (venta.clasificacion === 'exploracion') clasificacionBadgeClass = 'e-exploracion-badge';
            else if (venta.clasificacion === 'evaluacion') clasificacionBadgeClass = 'e-evaluacion-badge';
            else if (venta.clasificacion === 'decision') clasificacionBadgeClass = 'e-decision-badge';
            
            let tipoClienteBadgeClass = '';
            if (venta.tipoCliente === 'no-moto') tipoClienteBadgeClass = 'e-no-moto-badge';
            else if (venta.tipoCliente === 'cm') tipoClienteBadgeClass = 'e-cm-badge';
            else if (venta.tipoCliente === 'no-cm') tipoClienteBadgeClass = 'e-no-cm-badge';
            
            // Textos para mostrar
            const fuenteText = venta.fuente === 'digital' ? 'Digital' : 
                             venta.fuente === 'referido' ? 'Referido' : 
                             venta.fuente === 'playa' ? 'Playa' : 'Sala';
            
            const clasificacionText = venta.clasificacion === 'exploracion' ? 'Exploraci칩n' : 
                                    venta.clasificacion === 'evaluacion' ? 'Evaluaci칩n' : 'Decisi칩n';
            
            const tipoClienteText = venta.tipoCliente === 'no-moto' ? 'Cliente no moto el칠ctrica' : 
                                  venta.tipoCliente === 'cm' ? 'Cliente cuidad movil' : 'Cliente de otra marca';
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${venta.asesor}</td>
                <td>${venta.cliente}</td>
                <td>${venta.cedula || 'N/A'}</td>
                <td>${venta.celular}</td>
                <td><span class="e-tipo-badge ${tipoBadgeClass}">${venta.tipo ? venta.tipo.toUpperCase() : 'N/A'}</span></td>
                <td>${venta.referencia || 'N/A'}</td>
                <td>${venta.agencia || 'N/A'}</td>
                <td><span class="e-fuente-badge ${fuenteBadgeClass}">${fuenteText}</span></td>
                <td><span class="e-clasificacion-badge ${clasificacionBadgeClass}">${clasificacionText}</span></td>
                <td><span class="e-tipo-cliente-badge ${tipoClienteBadgeClass}">${tipoClienteText}</span></td>
            `;
            
            tbody.appendChild(row);
        });
        
        // Actualizar contador
        const contadorElement = document.getElementById('e-contadorVentas');
        if (contadorElement) {
            contadorElement.textContent = `Mostrando ${contador} ventas`;
        }
    }

    // Funci칩n para renderizar tabla de clientes
    function e_renderizarTablaClientes(filtroAsesor = 'all', filtroTipo = 'all') {
        const tbody = document.getElementById('e-clientesBodyDetalle');
        if (!tbody) return;
        
        tbody.innerHTML = '';
        
        let contador = 0;
        
        e_clientes.forEach(cliente => {
            // Aplicar filtros
            if (filtroAsesor !== 'all' && cliente.asesor.toUpperCase() !== filtroAsesor.toUpperCase()) return;
            if (filtroTipo !== 'all' && cliente.tipoVehiculo !== filtroTipo) return;
            
            contador++;
            
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${cliente.asesor}</td>
                <td>${cliente.fecha}</td>
                <td>${cliente.nombre}</td>
                <td>${cliente.cedula || 'N/A'}</td>
                <td>${cliente.celular || 'N/A'}</td>
                <td>${cliente.email || 'N/A'}</td>
                <td>${cliente.tipoCliente === 'digital' ? 'Digital' : cliente.tipoCliente === 'cm' ? 'Ciudad M칩vil' : cliente.tipoCliente === 'referido' ? 'Referido' : cliente.tipoCliente || 'N/A'}</td>
                <td>${cliente.fuente === 'digital' ? 'Digital' : cliente.fuente === 'referido' ? 'Referido' : cliente.fuente === 'playa' ? 'Playa' : cliente.fuente || 'N/A'}</td>
                <td>${cliente.tipoVehiculo ? cliente.tipoVehiculo.toUpperCase() : 'N/A'}</td>
                <td>${cliente.referencia || 'N/A'}</td>
                <td>${cliente.formaPago || 'N/A'}</td>
            `;
            
            tbody.appendChild(row);
        });
    }

    // Funci칩n para sincronizar filtros
    function e_sincronizarFiltros() {
        const filtroAsesor = document.getElementById('e-filtro-asesor');
        const filtroSede = document.getElementById('e-filtro-sede');
        const filtroTipo = document.getElementById('e-filtro-tipo');
        const filtroReferencia = document.getElementById('e-filtro-referencia');
        
        if (!filtroAsesor || !filtroSede || !filtroTipo || !filtroReferencia) return;
        
        // Funci칩n para actualizar todo
        function e_actualizarTodo() {
            const asesor = filtroAsesor.value;
            const sede = filtroSede.value;
            const tipo = filtroTipo.value;
            const referencia = filtroReferencia.value;
            
            // Actualizar la tabla de ventas
            e_renderizarTablaVentas(asesor, sede, tipo, referencia);
            
            // Si hay un asesor seleccionado, actualizar sus estad칤sticas
            if (asesor !== 'all') {
                e_mostrarEstadisticasAsesor(asesor, tipo, referencia);
            } else {
                // Ocultar estad칤sticas si se selecciona "Todos"
                const estadisticasContainer = document.getElementById('e-estadisticasAsesor');
                if (estadisticasContainer) {
                    estadisticasContainer.classList.remove('active');
                }
            }
        }
        
        // Cuando se selecciona un asesor, actualizar la sede
        filtroAsesor.addEventListener('change', function() {
            const asesor = this.value;
            
            if (asesor !== 'all' && e_asesorSedeMap[asesor]) {
                // Establecer la sede correspondiente al asesor
                filtroSede.value = e_asesorSedeMap[asesor];
            }
            
            e_actualizarTodo();
        });
        
        // Cuando se selecciona una sede, actualizar el asesor
        filtroSede.addEventListener('change', function() {
            const sede = this.value;
            
            if (sede !== 'all' && e_sedeAsesorMap[sede]) {
                // Si hay m칰ltiples asesores para una sede, establecer el primero
                filtroAsesor.value = e_sedeAsesorMap[sede][0];
            }
            
            e_actualizarTodo();
        });
        
        // Cuando se selecciona un tipo de veh칤culo
        filtroTipo.addEventListener('change', function() {
            const tipo = this.value;
            
            // Actualizar las referencias disponibles seg칰n el tipo
            e_actualizarReferencias(tipo);
            
            // Restablecer filtro de referencia a "Todas"
            filtroReferencia.value = 'all';
            
            e_actualizarTodo();
        });
        
        // Cuando se selecciona una referencia
        filtroReferencia.addEventListener('change', function() {
            e_actualizarTodo();
        });
    }

    // Inicializar dashboard
    function e_inicializarDashboard() {
        // Actualizar m칠tricas principales
        e_actualizarMetricas();
        
        // Actualizar tabla de ventas y prospectos
        e_actualizarTablaVentasProspectos();
        
        // Actualizar estad칤sticas
        e_actualizarEstadisticas();
        
        // Actualizar sedes
        e_actualizarSedes();
        
        // Inicializar opciones de referencia
        e_actualizarReferencias('all');
        
        // Renderizar tablas iniciales
        e_renderizarTablaVentas();
        e_renderizarTablaClientes();
        
        // Configurar sincronizaci칩n de filtros
        e_sincronizarFiltros();
        
        // Configurar filtro por asesor (clientes)
        const filtroClienteAsesor = document.getElementById('e-filtro-cliente-asesor');
        const filtroClienteTipo = document.getElementById('e-filtro-cliente-tipo');
        
        if (filtroClienteAsesor) {
            filtroClienteAsesor.addEventListener('change', function() {
                const asesor = this.value;
                const tipo = filtroClienteTipo ? filtroClienteTipo.value : 'all';
                e_renderizarTablaClientes(asesor, tipo);
            });
        }
        
        if (filtroClienteTipo) {
            filtroClienteTipo.addEventListener('change', function() {
                const tipo = this.value;
                const asesor = filtroClienteAsesor ? filtroClienteAsesor.value : 'all';
                e_renderizarTablaClientes(asesor, tipo);
            });
        }
        
        // Configurar bot칩n para cerrar estad칤sticas
        const cerrarEstadisticas = document.getElementById('e-cerrarEstadisticas');
        if (cerrarEstadisticas) {
            cerrarEstadisticas.addEventListener('click', function() {
                const estadisticasContainer = document.getElementById('e-estadisticasAsesor');
                if (estadisticasContainer) {
                    estadisticasContainer.classList.remove('active');
                }
                
                // Restablecer filtros a "Todos"
                const filtroAsesor = document.getElementById('e-filtro-asesor');
                const filtroSede = document.getElementById('e-filtro-sede');
                const filtroTipo = document.getElementById('e-filtro-tipo');
                const filtroReferencia = document.getElementById('e-filtro-referencia');
                
                if (filtroAsesor) filtroAsesor.value = 'all';
                if (filtroSede) filtroSede.value = 'all';
                if (filtroTipo) filtroTipo.value = 'all';
                if (filtroReferencia) filtroReferencia.value = 'all';
                
                // Actualizar tabla
                e_renderizarTablaVentas();
            });
        }
    }

    // Ejecutar inicializaci칩n despu칠s de un breve retraso
    setTimeout(e_inicializarDashboard, 50);
}

        function generarDashboardHTML(mes, anio) {
            return `
                <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
        <style>
        /* 
         * ESTILOS ENCAPSULADOS PARA WORDPRESS
         * Prefijo: e-dashboard- (electric dashboard)
         * Esto previene conflictos con estilos del tema
         */

        /* Reset solo para nuestro dashboard */
        .e-dashboard-vehiculos-electricos * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .e-dashboard-vehiculos-electricos {
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: #333;
            padding: 20px;
            min-height: 800px;
        }

        .e-dashboard-container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* Header */
        .e-dashboard-vehiculos-electricos header {
            text-align: center;
            margin-bottom: 30px;
            padding: 20px;
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .e-dashboard-vehiculos-electricos h1 {
            color: #2c3e50;
            margin-bottom: 10px;
            font-size: 2.5rem;
        }

        .e-dashboard-vehiculos-electricos .e-subtitle {
            color: #7f8c8d;
            font-size: 1.2rem;
        }

        /* Resumen Ejecutivo */
        .e-dashboard-vehiculos-electricos .e-resumen-ejecutivo {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .e-dashboard-vehiculos-electricos .e-metrica-card {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }

        .e-dashboard-vehiculos-electricos .e-metrica-card:hover {
            transform: translateY(-5px);
        }

        .e-dashboard-vehiculos-electricos .e-metrica-valor {
            font-size: 2.5rem;
            font-weight: bold;
            color: #2c3e50;
            margin: 10px 0;
        }

        .e-dashboard-vehiculos-electricos .e-metrica-label {
            color: #7f8c8d;
            font-size: 1rem;
        }

        .e-dashboard-vehiculos-electricos .e-asesores {
            color: #3498db;
        }

        .e-dashboard-vehiculos-electricos .e-sucursales {
            color: #9b59b6;
        }

        .e-dashboard-vehiculos-electricos .e-ventas {
            color: #27ae60;
        }

        .e-dashboard-vehiculos-electricos .e-clientes {
            color: #e74c3c;
        }

        /* Tabla de Ventas y Prospectos por Asesor - CORREGIDO */
        .e-dashboard-vehiculos-electricos .e-tabla-ventas-prospectos {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .e-dashboard-vehiculos-electricos .e-tabla-ventas-prospectos h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .e-dashboard-vehiculos-electricos .e-tabla-doble-container {
            overflow-x: auto;
        }

        .e-dashboard-vehiculos-electricos .e-tabla-completa {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        /* Encabezados generales - fondo azul oscuro */
        .e-dashboard-vehiculos-electricos .e-tabla-completa th {
            background: #2c3e50 !important;
            color: white !important;
            padding: 12px;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        /* PROSPECTOS - fondo naranja */
        .e-dashboard-vehiculos-electricos .e-tabla-completa tr:first-child th[colspan="3"]:last-child {
            background: #e67e22 !important;
            color: white !important;
        }

        /* PPTO, Real, % - fondo naranja en segunda fila */
        .e-dashboard-vehiculos-electricos .e-tabla-completa tr.e-separador th:nth-last-child(3),
        .e-dashboard-vehiculos-electricos .e-tabla-completa tr.e-separador th:nth-last-child(2),
        .e-dashboard-vehiculos-electricos .e-tabla-completa tr.e-separador th:nth-last-child(1) {
            background: #e67e22 !important;
            color: white !important;
        }

        /* Celdas de datos */
        .e-dashboard-vehiculos-electricos .e-tabla-completa td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
            text-align: center;
            color: #000000;
        }

        /* Clases para celdas de datos - VENTAS */
        .e-dashboard-vehiculos-electricos .e-tabla-completa .e-columna-ventas {
            background-color: #e8f6f3;
        }

        /* Clases para celdas de datos - PROSPECTOS */
        .e-dashboard-vehiculos-electricos .e-tabla-completa .e-columna-prospectos {
            background-color: #fef9e7;
        }

        /* Asegurar fondos para celdas de datos VENTAS */
        .e-dashboard-vehiculos-electricos .e-tabla-completa tr td.e-columna-ventas {
            background-color: #e8f6f3 !important;
        }

        /* Asegurar fondos para celdas de datos PROSPECTOS */
        .e-dashboard-vehiculos-electricos .e-tabla-completa tr td.e-columna-prospectos {
            background-color: #fef9e7 !important;
        }

        /* Fila separadora */
        .e-dashboard-vehiculos-electricos .e-tabla-completa .e-separador {
            background: #34495e;
            color: white !important;
            font-weight: bold;
        }

        /* Fila de totales */
        .e-dashboard-vehiculos-electricos .e-tabla-completa .e-total-row {
            background-color: #2c3e50;
            color: white !important;
            font-weight: bold;
        }

        /* Efecto hover en filas */
        .e-dashboard-vehiculos-electricos .e-tabla-completa tr:hover {
            background: #f8f9fa;
        }

        .e-dashboard-vehiculos-electricos .e-tabla-completa .e-total-row:hover {
            background-color: #2c3e50;
        }

        /* Colores para porcentajes */
        .e-dashboard-vehiculos-electricos .e-porcentaje-bueno {
            color: #27ae60 !important;
            font-weight: bold;
        }

        .e-dashboard-vehiculos-electricos .e-porcentaje-medio {
            color: #f39c12 !important;
            font-weight: bold;
        }

        .e-dashboard-vehiculos-electricos .e-porcentaje-bajo {
            color: #e74c3c !important;
            font-weight: bold;
        }

        /* Estad칤sticas */
        .e-dashboard-vehiculos-electricos .e-estadisticas-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .e-dashboard-vehiculos-electricos .e-estadistica-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .e-dashboard-vehiculos-electricos .e-estadistica-card h3 {
            margin-bottom: 15px;
            color: #2c3e50;
        }

        .e-dashboard-vehiculos-electricos .e-estadistica-table {
            width: 100%;
            border-collapse: collapse;
        }

        .e-dashboard-vehiculos-electricos .e-estadistica-table th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .e-dashboard-vehiculos-electricos .e-estadistica-table td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        .e-dashboard-vehiculos-electricos .e-estadistica-table tr:hover {
            background: #f8f9fa;
        }

        .e-dashboard-vehiculos-electricos .e-total-row {
            background-color: #f8f9fa;
            font-weight: bold;
            border-top: 2px solid #2c3e50;
        }

        /* Sedes */
        .e-dashboard-vehiculos-electricos .e-sedes-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .e-dashboard-vehiculos-electricos .e-sede-card {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .e-dashboard-vehiculos-electricos .e-sede-card h3 {
            margin-bottom: 15px;
            color: #2c3e50;
            padding-bottom: 10px;
            border-bottom: 2px solid #ecf0f1;
        }

        .e-dashboard-vehiculos-electricos .e-sede-info {
            margin-top: 10px;
        }

        .e-dashboard-vehiculos-electricos .e-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding: 5px 0;
        }

        .e-dashboard-vehiculos-electricos .e-info-item .e-valor {
            font-weight: bold;
            color: #2c3e50;
        }

        /* Filtros */
        .e-dashboard-vehiculos-electricos .e-filtros-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .e-dashboard-vehiculos-electricos .e-filtros-container h3 {
            margin-bottom: 20px;
            color: #2c3e50;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .e-dashboard-vehiculos-electricos .e-filtros-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .e-dashboard-vehiculos-electricos .e-filtro-group {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .e-dashboard-vehiculos-electricos .e-filtro-group h4 {
            margin-bottom: 10px;
            color: #2c3e50;
            font-size: 1.1rem;
        }

        .e-dashboard-vehiculos-electricos select {
            width: 100%;
            padding: 10px 15px;
            border-radius: 5px;
            border: 1px solid #bdc3c7;
            background: white;
            font-size: 1rem;
            margin-bottom: 10px;
        }

        .e-dashboard-vehiculos-electricos select:last-child {
            margin-bottom: 0;
        }

        /* Tablas */
        .e-dashboard-vehiculos-electricos .e-tabla-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            overflow-x: auto;
        }

        .e-dashboard-vehiculos-electricos .e-tabla-titulo {
            margin-bottom: 15px;
            color: #2c3e50;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .e-dashboard-vehiculos-electricos .e-ventas-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1000px;
        }

        .e-dashboard-vehiculos-electricos .e-ventas-table th {
            background: #2c3e50;
            color: white;
            padding: 15px;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .e-dashboard-vehiculos-electricos .e-ventas-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
        }

        .e-dashboard-vehiculos-electricos .e-ventas-table tr:hover {
            background: #f8f9fa;
        }

        /* Badges */
        .e-dashboard-vehiculos-electricos .e-tipo-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: bold;
        }

        .e-dashboard-vehiculos-electricos .e-moto-badge {
            background: #d5f4e6;
            color: #27ae60;
        }

        .e-dashboard-vehiculos-electricos .e-patineta-badge {
            background: #e8f4fc;
            color: #3498db;
        }

        .e-dashboard-vehiculos-electricos .e-carro-badge {
            background: #f4e8fc;
            color: #9b59b6;
        }

        .e-dashboard-vehiculos-electricos .e-bicicleta-badge {
            background: #fef9e7;
            color: #f39c12;
        }

        .e-dashboard-vehiculos-electricos .e-fuente-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .e-dashboard-vehiculos-electricos .e-digital-badge {
            background: #e8f6f3;
            color: #1abc9c;
        }

        .e-dashboard-vehiculos-electricos .e-referido-badge {
            background: #fef9e7;
            color: #f39c12;
        }

        .e-dashboard-vehiculos-electricos .e-playa-badge {
            background: #fdedec;
            color: #e74c3c;
        }

        .e-dashboard-vehiculos-electricos .e-sala-badge {
            background: #e8f4fd;
            color: #3498db;
        }

        .e-dashboard-vehiculos-electricos .e-clasificacion-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .e-dashboard-vehiculos-electricos .e-exploracion-badge {
            background: #ebf5fb;
            color: #3498db;
        }

        .e-dashboard-vehiculos-electricos .e-evaluacion-badge {
            background: #fef5e7;
            color: #f39c12;
        }

        .e-dashboard-vehiculos-electricos .e-decision-badge {
            background: #eafaf1;
            color: #27ae60;
        }

        .e-dashboard-vehiculos-electricos .e-tipo-cliente-badge {
            display: inline-block;
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .e-dashboard-vehiculos-electricos .e-nuevo-badge {
            background: #e8f8f5;
            color: #1abc9c;
        }

        .e-dashboard-vehiculos-electricos .e-cm-badge {
            background: #f4ecf7;
            color: #9b59b6;
        }

        .e-dashboard-vehiculos-electricos .e-no-moto-badge {
            background: #e8f4fd;
            color: #3498db;
        }

        .e-dashboard-vehiculos-electricos .e-no-cm-badge {
            background: #fbeee6;
            color: #e67e22;
        }

        /* Clientes */
        .e-dashboard-vehiculos-electricos .e-clientes-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .e-dashboard-vehiculos-electricos .e-clientes-table {
            width: 100%;
            border-collapse: collapse;
            min-width: 1200px;
        }

        .e-dashboard-vehiculos-electricos .e-clientes-table th {
            background: #2c3e50;
            color: white;
            padding: 12px;
            text-align: left;
        }

        .e-dashboard-vehiculos-electricos .e-clientes-table td {
            padding: 10px;
            border-bottom: 1px solid #ecf0f1;
        }

        .e-dashboard-vehiculos-electricos .e-clientes-table tr:hover {
            background: #f8f9fa;
        }

        /* Estad칤sticas del Asesor */
        .e-dashboard-vehiculos-electricos .e-estadisticas-asesor-container {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            display: none;
        }

        .e-dashboard-vehiculos-electricos .e-estadisticas-asesor-container.active {
            display: block;
        }

        .e-dashboard-vehiculos-electricos .e-asesor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #ecf0f1;
        }

        .e-dashboard-vehiculos-electricos .e-asesor-header h3 {
            color: #2c3e50;
            font-size: 1.5rem;
        }

        .e-dashboard-vehiculos-electricos .e-cerrar-estadisticas {
            background: #e74c3c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .e-dashboard-vehiculos-electricos .e-cerrar-estadisticas:hover {
            background: #c0392b;
        }

        .e-dashboard-vehiculos-electricos .e-estadisticas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .e-dashboard-vehiculos-electricos .e-estadisticas-seccion {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .e-dashboard-vehiculos-electricos .e-estadisticas-seccion h4 {
            margin-bottom: 15px;
            color: #2c3e50;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .e-dashboard-vehiculos-electricos .e-estadistica-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            padding: 8px 0;
            border-bottom: 1px dashed #dee2e6;
        }

        .e-dashboard-vehiculos-electricos .e-estadistica-item:last-child {
            border-bottom: none;
        }

        .e-dashboard-vehiculos-electricos .e-estadistica-item .e-valor {
            font-weight: bold;
            color: #2c3e50;
        }

        /* Gr치fico de Barras */
        .e-dashboard-vehiculos-electricos .e-barras-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            margin-top: 20px;
        }

        .e-dashboard-vehiculos-electricos .e-barras-container h4 {
            margin-bottom: 20px;
            color: #2c3e50;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .e-dashboard-vehiculos-electricos .e-barra-item {
            margin-bottom: 15px;
        }

        .e-dashboard-vehiculos-electricos .e-barra-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }

        .e-dashboard-vehiculos-electricos .e-barra-progreso {
            height: 25px;
            background: #ecf0f1;
            border-radius: 5px;
            overflow: hidden;
            position: relative;
        }

        .e-dashboard-vehiculos-electricos .e-barra-progreso-fill {
            height: 100%;
            background: linear-gradient(90deg, #3498db, #2ecc71);
            border-radius: 5px;
            transition: width 1s ease-in-out;
            display: flex;
            align-items: center;
            padding-left: 10px;
            color: white;
            font-weight: bold;
            font-size: 0.8rem;
        }

        /* Colores para diferentes tipos */
        .e-dashboard-vehiculos-electricos .e-barra-moto {
            background: linear-gradient(90deg, #27ae60, #2ecc71);
        }

        .e-dashboard-vehiculos-electricos .e-barra-patineta {
            background: linear-gradient(90deg, #3498db, #2980b9);
        }

        .e-dashboard-vehiculos-electricos .e-barra-carro {
            background: linear-gradient(90deg, #9b59b6, #8e44ad);
        }

        .e-dashboard-vehiculos-electricos .e-barra-bicicleta {
            background: linear-gradient(90deg, #f39c12, #e67e22);
        }

        /* Footer */
        .e-dashboard-vehiculos-electricos footer {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
            margin-top: 30px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .e-dashboard-vehiculos-electricos .e-filtros-grid {
                grid-template-columns: 1fr;
            }
            
            .e-dashboard-vehiculos-electricos .e-estadisticas-container {
                grid-template-columns: 1fr;
            }
            
            .e-dashboard-vehiculos-electricos .e-estadisticas-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Asegurar que solo nuestro dashboard use estas fuentes */
        .e-dashboard-vehiculos-electricos,
        .e-dashboard-vehiculos-electricos *:not(i) {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif !important;
        }
        </style>
        <div class="e-dashboard-vehiculos-electricos">
            <div class="e-dashboard-container">
                <header>
                    <h1><i class="fas fa-chart-line"></i> Dashboard de Ventas - ${mes} ${anio}</h1>
                    <p class="e-subtitle">Veh칤culos El칠ctricos - Monitoreo en Tiempo Real</p>
                </header>

                <div class="e-resumen-ejecutivo">
                    <div class="e-metrica-card e-asesores">
                        <i class="fas fa-users fa-2x"></i>
                        <div class="e-metrica-valor" id="e-metricaAsesores">0</div>
                        <div class="e-metrica-label">N칰mero de Asesores</div>
                    </div>
                    <div class="e-metrica-card e-sucursales">
                        <i class="fas fa-store fa-2x"></i>
                        <div class="e-metrica-valor" id="e-metricaSucursales">0</div>
                        <div class="e-metrica-label">N칰mero de Sucursales</div>
                    </div>
                    <div class="e-metrica-card e-ventas">
                        <i class="fas fa-car fa-2x"></i>
                        <div class="e-metrica-valor" id="e-metricaVentas">0</div>
                        <div class="e-metrica-label">Ventas Totales</div>
                    </div>
                    <div class="e-metrica-card e-clientes">
                        <i class="fas fa-user-check fa-2x"></i>
                        <div class="e-metrica-valor" id="e-metricaClientes">0</div>
                        <div class="e-metrica-label">Total de Clientes</div>
                    </div>
                </div>

                <!-- Nueva tabla de ventas y prospectos por asesor CORREGIDA -->
                <div class="e-tabla-ventas-prospectos">
                    <h3><i class="fas fa-chart-bar"></i> Ventas y Prospectos por Asesor</h3>
                    <div class="e-tabla-doble-container">
                        <table class="e-tabla-completa" id="e-tablaVentasProspectos">
                            <thead>
                                <tr>
                                    <th>Asesor</th>
                                    <th colspan="2" class="e-columna-ventas">VENTAS</th>
                                    <th colspan="3" class="e-columna-ventas">EFECTIVIDAD VENTAS</th>
                                    <th colspan="3" class="e-columna-prospectos">PROSPECTOS</th>
                                </tr>
                                <tr class="e-separador">
                                    <th></th>
                                    <th class="e-columna-ventas">PPTO ($)</th>
                                    <th class="e-columna-ventas">Real ($)</th>
                                    <th class="e-columna-ventas">PPTO</th>
                                    <th class="e-columna-ventas">Real</th>
                                    <th class="e-columna-ventas">%</th>
                                    <th class="e-columna-prospectos">PPTO</th>
                                    <th class="e-columna-prospectos">Real</th>
                                    <th class="e-columna-prospectos">%</th>
                                </tr>
                            </thead>
                            <tbody id="e-tablaVentasProspectosBody">
                                <!-- Se llenar치 din치micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="e-estadisticas-container">
                    <div class="e-estadistica-card">
                        <h3><i class="fas fa-chart-bar"></i> Ventas por Tipo de Veh칤culo</h3>
                        <table class="e-estadistica-table" id="e-tablaTipoVehiculo">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Cantidad</th>
                                    <th>Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llenar치 din치micamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="e-estadistica-card">
                        <h3><i class="fas fa-users"></i> Fuentes de Clientes</h3>
                        <table class="e-estadistica-table" id="e-tablaFuentesClientes">
                            <thead>
                                <tr>
                                    <th>Fuente</th>
                                    <th>Cantidad</th>
                                    <th>Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llenar치 din치micamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="e-estadistica-card">
                        <h3><i class="fas fa-chart-line"></i> Clasificaci칩n de Clientes</h3>
                        <table class="e-estadistica-table" id="e-tablaClasificacionClientes">
                            <thead>
                                <tr>
                                    <th>Etapa</th>
                                    <th>Cantidad</th>
                                    <th>Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llenar치 din치micamente -->
                            </tbody>
                        </table>
                    </div>
                    
                    <div class="e-estadistica-card">
                        <h3><i class="fas fa-user-tag"></i> Tipo de Cliente</h3>
                        <table class="e-estadistica-table" id="e-tablaTipoCliente">
                            <thead>
                                <tr>
                                    <th>Tipo</th>
                                    <th>Cantidad</th>
                                    <th>Porcentaje</th>
                                </tr>
                            </thead>
                            <tbody>
                                <!-- Se llenar치 din치micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="e-sedes-container" id="e-sedesContainer">
                    <!-- Se llenar치 din치micamente -->
                </div>

                <!-- Estad칤sticas del Asesor Seleccionado -->
                <div class="e-estadisticas-asesor-container" id="e-estadisticasAsesor">
                    <div class="e-asesor-header">
                        <h3 id="e-nombreAsesorEstadisticas">Estad칤sticas del Asesor</h3>
                        <button class="e-cerrar-estadisticas" id="e-cerrarEstadisticas">
                            <i class="fas fa-times"></i> Cerrar
                        </button>
                    </div>
                    
                    <div class="e-estadisticas-grid">
                        <div class="e-estadisticas-seccion">
                            <h4><i class="fas fa-motorcycle"></i> Distribuci칩n de Ventas</h4>
                            <div class="e-estadistica-item">
                                <span>Motos:</span>
                                <span class="e-valor" id="e-estMotos">0</span>
                            </div>
                            <div class="e-estadistica-item">
                                <span>Patinetas:</span>
                                <span class="e-valor" id="e-estPatinetas">0</span>
                            </div>
                            <div class="e-estadistica-item">
                                <span>Carros:</span>
                                <span class="e-valor" id="e-estCarros">0</span>
                            </div>
                            <div class="e-estadistica-item">
                                <span>Bicicletas:</span>
                                <span class="e-valor" id="e-estBicicletas">0</span>
                            </div>
                        </div>
                        
                        <div class="e-estadisticas-seccion">
                            <h4><i class="fas fa-users"></i> Fuente de Clientes</h4>
                            <div class="e-estadistica-item">
                                <span>Sala:</span>
                                <span class="e-valor" id="e-estSala">0</span>
                            </div>
                            <div class="e-estadistica-item">
                                <span>Digital:</span>
                                <span class="e-valor" id="e-estDigital">0</span>
                            </div>
                            <div class="e-estadistica-item">
                                <span>Referido:</span>
                                <span class="e-valor" id="e-estReferido">0</span>
                            </div>
                            <div class="e-estadistica-item">
                                <span>Playa:</span>
                                <span class="e-valor" id="e-estPlaya">0</span>
                            </div>
                        </div>
                        
                        <div class="e-estadisticas-seccion">
                            <h4><i class="fas fa-chart-line"></i> Clasificaci칩n</h4>
                            <div class="e-estadistica-item">
                                <span>Exploraci칩n:</span>
                                <span class="e-valor" id="e-estExploracion">0</span>
                            </div>
                            <div class="e-estadistica-item">
                                <span>Evaluaci칩n:</span>
                                <span class="e-valor" id="e-estEvaluacion">0</span>
                            </div>
                            <div class="e-estadistica-item">
                                <span>Decisi칩n:</span>
                                <span class="e-valor" id="e-estDecision">0</span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="e-barras-container">
                        <h4><i class="fas fa-chart-bar"></i> Referencias Vendidas</h4>
                        <div id="e-graficoReferencias">
                            <!-- Aqu칤 se generar치n las barras din치micamente -->
                        </div>
                    </div>
                </div>

                <div class="e-filtros-container">
                    <h3><i class="fas fa-filter"></i> Filtros de Ventas</h3>
                    <div class="e-filtros-grid">
                        <div class="e-filtro-group">
                            <h4><i class="fas fa-user-tie"></i> Filtrar por Asesor</h4>
                            <select id="e-filtro-asesor">
                                <option value="all">Todos</option>
                                <option value="YOLANDA">Yolanda</option>
                                <option value="SANDRA">Sandra</option>
                                <option value="LINA">Lina</option>
                                <option value="FABIOLA">Fabiola</option>
                                <option value="ADRIANA">Adriana</option>
                                <option value="DINA LUZ">Dina Luz</option>
                            </select>
                        </div>
                        
                        <div class="e-filtro-group">
                            <h4><i class="fas fa-store"></i> Filtrar por Sede</h4>
                            <select id="e-filtro-sede">
                                <option value="all">Todas</option>
                                <option value="Cra 33 Cabecera">Cra 33 Cabecera</option>
                                <option value="La Concordia">La Concordia</option>
                                <option value="Giron">Giron</option>
                                <option value="Barrancabermeja">Barrancabermeja</option>
                                <option value="Valledupar">Valledupar</option>
                            </select>
                        </div>
                        
                        <div class="e-filtro-group">
                            <h4><i class="fas fa-car"></i> Tipo de Veh칤culo</h4>
                            <select id="e-filtro-tipo">
                                <option value="all">Todos</option>
                                <option value="moto">Moto</option>
                                <option value="patineta">Patineta</option>
                                <option value="carro">Carro</option>
                                <option value="bicicleta">Bicicleta</option>
                            </select>
                            
                            <h4><i class="fas fa-tag"></i> Marca/Referencia</h4>
                            <select id="e-filtro-referencia">
                                <option value="all">Todas</option>
                                <!-- Las opciones se llenar치n din치micamente -->
                            </select>
                        </div>
                    </div>
                </div>

                <div class="e-tabla-container">
                    <div class="e-tabla-titulo">
                        <h3><i class="fas fa-table"></i> Ventas Realizadas</h3>
                        <div id="e-contadorVentas">Mostrando 0 ventas</div>
                    </div>
                    <table class="e-ventas-table" id="e-tablaVentasDetalle">
                        <thead>
                            <tr>
                                <th>Asesor</th>
                                <th>Cliente</th>
                                <th>C칠dula</th>
                                <th>Celular</th>
                                <th>Tipo Veh칤culo</th>
                                <th>Referencia</th>
                                <th>Agencia</th>
                                <th>Fuente</th>
                                <th>Clasificaci칩n</th>
                                <th>Tipo Cliente</th>
                            </tr>
                        </thead>
                        <tbody id="e-tablaVentasDetalleBody">
                            <!-- Ventas se cargar치n din치micamente -->
                        </tbody>
                    </table>
                </div>

                <div class="e-clientes-container">
                    <div class="e-tabla-titulo">
                        <h3><i class="fas fa-database"></i> Base de Datos de Clientes</h3>
                    </div>
                    <div class="e-filtros-grid" style="margin-bottom: 20px;">
                        <div class="e-filtro-group">
                            <h4><i class="fas fa-user-tie"></i> Filtrar por Asesor</h4>
                            <select id="e-filtro-cliente-asesor">
                                <option value="all">Todos</option>
                                <option value="YOLANDA">Yolanda</option>
                                <option value="SANDRA">Sandra</option>
                                <option value="LINA">Lina</option>
                                <option value="FABIOLA">Fabiola</option>
                                <option value="ADRIANA">Adriana</option>
                                <option value="DINA LUZ">Dina Luz</option>
                            </select>
                        </div>
                        
                        <div class="e-filtro-group">
                            <h4><i class="fas fa-car"></i> Tipo de Veh칤culo</h4>
                            <select id="e-filtro-cliente-tipo">
                                <option value="all">Todos</option>
                                <option value="moto">Moto</option>
                                <option value="patineta">Patineta</option>
                                <option value="carro">Carro</option>
                                <option value="bicicleta">Bicicleta</option>
                            </select>
                        </div>
                    </div>
                    <div style="overflow-x: auto;">
                        <table class="e-clientes-table" id="e-tablaClientesDetalle">
                            <thead>
                                <tr>
                                    <th>Asesor</th>
                                    <th>Fecha</th>
                                    <th>Nombre</th>
                                    <th>C칠dula</th>
                                    <th>Celular</th>
                                    <th>Email</th>
                                    <th>Tipo Cliente</th>
                                    <th>Fuente</th>
                                    <th>Tipo Veh칤culo</th>
                                    <th>Referencia</th>
                                    <th>Forma de Pago</th>
                                </tr>
                            </thead>
                            <tbody id="e-clientesBodyDetalle">
                                <!-- Clientes se cargar치n din치micamente -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <footer>
                    <p>Dashboard de Ventas - Veh칤culos El칠ctricos | Actualizado: ${mes} ${anio}</p>
                    <p>Sistema Integrado de Gesti칩n Comercial</p>
                </footer>
            </div>
        </div>
            `;
            return dashboardHTML;
        }

        // ==================== RENDER PRINCIPAL ====================

        function render() {
            // Determinar vista inicial
            if (!currentUser) {
                currentView = "login";
                localStorage.setItem("currentView", currentView);
            } else if (!currentView) {
                currentView =
                    currentUser.rol === "gerente"
                        ? "dashboard_gerente"
                        : "dashboard_asesor";
                localStorage.setItem("currentView", currentView);
            }

            // Renderizar vista correspondiente
            switch (currentView) {
                case "login":
            renderLogin();
            break;
        case "dashboard_gerente":
            renderDashboardGerente();
            break;
        case "gestion_asesores":
            renderGestionAsesores();
            break;
        case "editar_presupuestos":
            renderEditarPresupuestos();
            break;
        case "ingresar_ventas":
            renderIngresarVentas();
            break;
        case "dashboard_asesor":
            renderDashboardAsesor();
            break;
        case "perfil":
            renderPerfil();
            break;
        case "editar_venta":  // <-- NUEVO CASO AGREGADO
            if (window.ventaIdParaEditar) {
                renderEditarVenta(window.ventaIdParaEditar);
            } else {
                navigate('ingresar_ventas');
            }
            break;
        default:
            currentView = "login";
            localStorage.setItem("currentView", currentView);
            renderLogin();
            }
        }

        // ==================== INICIALIZACI칍N ====================

        // Inicializar cuando se carga la p치gina
        document.addEventListener("DOMContentLoaded", async function () {
    await initData(); // Ahora es async
    render();
    
    // Exponer funciones globales necesarias
    window.selectLoginRole = selectLoginRole;
    window.handleLogin = handleLogin;
    window.mostrarRegistro = mostrarRegistro;
    window.cerrarModalRegistro = cerrarModalRegistro;
    window.handleRegistro = handleRegistro;
    window.navigate = navigate;
    window.logout = logout;
    window.editarAsesor = editarAsesor;
    window.eliminarAsesor = eliminarAsesor;
    window.guardarAsesor = guardarAsesor;
    window.cerrarModal = cerrarModal;
    window.crearAsesor = crearAsesor;
    window.actualizarPerfil = actualizarPerfil;
    window.cargarFotoPerfil = cargarFotoPerfil;
    window.cambiarContrase침a = cambiarContrase침a;
    window.initializeDashboardFilters = initializeDashboardFilters;
    window.loadDashboard = loadDashboard;
    window.cargarPresupuestos = cargarPresupuestos;
    window.guardarPresupuestos = guardarPresupuestos;
    window.resetearPresupuestos = resetearPresupuestos;
    window.cargarFormularioIngreso = cargarFormularioIngreso;
    window.mostrarCampoValor = mostrarCampoValor;
    window.limpiarFormulario = limpiarFormulario;
    window.guardarIngreso = guardarIngreso;
    window.calcularVentasReales = calcularVentasReales;
    window.cargarRegistrosRecientes = cargarRegistrosRecientes;
    window.editarRegistro = editarRegistro;
    window.renderEditarVenta = renderEditarVenta;
    window.mostrarCampoValorEditar = mostrarCampoValorEditar;
    window.guardarEdicionVenta = guardarEdicionVenta;
    window.eliminarRegistro = eliminarRegistro;
    
    // Mostrar mensaje de conexi칩n
    if (db) {
        console.log("Sistema conectado a Firebase");
    } else {
        console.log("Sistema funcionando en modo local (Firebase no disponible)");
    }
});
    </script>
</body>

</html>